<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Camino</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
       :root {
    --primary: #1e3a8a;       /* Azul marinho elegante */
    --secondary: #0f766e;     /* Verde água sofisticado */
    --accent: #d97706;        /* Dourado/Âmbar para destaques */
    --success: #065f46;       /* Verde esmeralda */
    --warning: #b45309;       /* Laranja terroso */
    --danger: #991b1b;        /* Vermelho vinho */
    --dark: #1f2937;          /* Mantido - neutro profissional */
    --light: #f8fafc;         /* Branco mais suave */
    --gray: #6b7280;          /* Mantido */
    --border: #e5e7eb;        /* Mantido */
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f3f4f6;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .logo-img {
            height: 40px;
            width: auto;
            object-fit: contain;
            border-radius: 6px;
            transition: transform 0.3s ease;
        }

        .logo-img:hover {
            transform: scale(1.05);
        }

        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .tab.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab:hover:not(.active) {
            background-color: #e5e7eb;
        }

        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-header {
            margin-bottom: 24px;
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-subtitle {
            color: var(--gray);
            font-size: 16px;
        }

        .filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            width: 100%;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .metric-header .icon {
            width: 40px;
            height: 40px;
            background-color: var(--light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .metric-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .metric-content p {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 4px;
        }

        .metric-content strong {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-top: 8px;
        }

        .metric-content .info-text {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 4px;
        }

        .timeline-header {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
        }

        .timeline-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 20px;
            padding-bottom: 10px;
            margin-bottom: 30px;
            scroll-behavior: smooth;
        }

        .timeline-card {
            flex: 0 0 auto;
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .timeline-card h4 {
            font-size: 1rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-card h5 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .timeline-card ul {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
        }

        .timeline-card ul li {
            position: relative;
            padding-left: 20px;
            font-size: 0.9rem;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .timeline-card ul li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .chart-card h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .table-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 250px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .atendimentos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .atendimentos-table th {
            background-color: var(--light);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .atendimentos-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .atendimentos-table tr:hover {
            background-color: #f8fafc;
        }

        .atendimentos-table tr:last-child td {
            border-bottom: none;
        }

        .diretoria-badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1;
            color: #ffffff;
            background-color: #6b7280;
        }

        .diretoria-store {
            background-color: #6366f1;
        }

        .diretoria-sell {
            background-color: #06b6d4;
            color: #000000;
        }

        .diretoria-parcerias {
            background-color: #f59e0b;
        }

        .tipo-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: #e5e7eb;
            color: var(--dark);
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            background-color: var(--light);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .header-pipeline {
            margin-bottom: 24px;
        }

        .pipeline-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            width: 100%;
        }

        .pipeline-col {
            flex: 0 0 320px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        .col-header {
            padding: 15px;
            border-bottom: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background-color: var(--light);
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            flex-shrink: 0;
        }

        .col-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .col-header .count {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--dark);
        }

        .col-header .count-value {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.8em;
            font-weight: 600;
            white-space: nowrap;
        }

        .col-header .vgv-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success);
            margin-top: 5px;
        }

        .col-content {
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
            background-color: #f9fafb;
        }

        .pipeline-diretoria {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border);
        }

        .pipeline-diretoria:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .pipeline-diretoria h4 {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            padding: 5px 0;
            border-left: 3px solid var(--secondary);
            padding-left: 8px;
            display: flex;
            justify-content: space-between;
        }

        .diretoria-vgv {
            font-size: 0.9em;
            font-weight: 700;
            color: var(--primary);
        }

        .tratativa-row {
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 3px;
            background: white;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
        }

        .tratativa-row:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .tratativa-row-vendido { border-left: 5px solid var(--success); }
        .tratativa-row-processo { border-left: 5px solid var(--primary); }
        .tratativa-row-proposta { border-left: 5px solid var(--warning); }
        .tratativa-row-tratativa { border-left: 5px solid #06b6d4; }

        .row-unit {
            font-weight: 500;
            color: var(--dark);
            max-width: 65%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .row-origin {
            font-weight: 500;
            font-size: 0.9em;
            color: var(--gray);
            white-space: nowrap;
        }

        .tooltip {
            position: absolute;
            background-color: var(--dark);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.4;
            max-width: 250px;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }

        .tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid var(--dark);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.warning {
            background-color: var(--warning);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary);
        }

        .error-message {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-message {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .warning-message {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .filter-container {
                grid-template-columns: 1fr;
            }
            .timeline-card {
                width: 280px;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            .search-box {
                width: 100%;
            }
            .table-actions {
                justify-content: space-between;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">
            <img src="https://caminoaltodaboavista.touchapp.com.br/img/logo.png" 
                 alt="Logo Projeto" 
                 class="logo-img">
            <i class="fas fa-chart-line"></i>
            <span>DASH CAMINO ALTO DA BOA VISTA</span>
        </div>
        <div class="tabs">
            <div class="tab active" data-target="resumo">Resumo da Semana</div>
            <div class="tab" data-target="panorama-estoque">Panorama Estoque</div>
            <div class="tab" data-target="controle-atendimentos">Controle de Atendimentos</div>
            <div class="tab" data-target="tratativas">Pipeline de Tratativas</div>
        </div>
    </header>

    <div id="statusArea"></div>

    <!-- ABA RESUMO DA SEMANA DINÂMICA -->
    <div id="resumo" class="dashboard active">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-bullhorn" style="color: #f59e0b;"></i>
                Resumo da Semana
            </h1>
            <p class="dashboard-subtitle" id="resumoPeriodo">Carregando período...</p>
        </div>

        <div class="filter-container">
            <div class="date-range">
                <div class="filter-group">
                    <label for="resumoDataInicio"><i class="fas fa-calendar"></i> Data Início</label>
                    <input type="date" id="resumoDataInicio" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="resumoDataFim"><i class="fas fa-calendar"></i> Data Fim</label>
                    <input type="date" id="resumoDataFim" class="filter-input">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="aplicarFiltroResumo()">
                    <i class="fas fa-filter"></i> Aplicar Filtro
                </button>
                <button class="btn btn-secondary" onclick="definirSemanaAtual()">
                    <i class="fas fa-calendar-week"></i> Semana Atual
                </button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card" id="cardTotalAtendimentosSemana">
                <div class="metric-header">
<div class="icon" style="color: #1e3a8a;"><i class="fas fa-users"></i></div>
                    <h3>TOTAL</h3>
                </div>
                <div class="metric-content">
                    <p>Total da semana:</p>
                    <strong id="totalAtendimentosSemana">0</strong>
                    <p class="info-text">Atendimentos registrados no período</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
<div class="icon" style="color: #0f766e;"><i class="fas fa-door-open"></i></div>
                    <h3>Vez</h3>
                </div>
                <div class="metric-content">
                    <p>Total de visitas:</p>
                    <strong id="resumoVisitas">0</strong>
                    <p class="info-text" id="resumoVisitasDetalhe">Carregando...</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
<div class="icon" style="color: #d97706;"><i class="fas fa-user-friends"></i></div>
                    <h3>Indicações</h3>
                </div>
                <div class="metric-content">
                    <p>Total de indicações:</p>
                    <strong id="resumoIndicacoes">0</strong>
                    <p class="info-text" id="resumoIndicacoesDetalhe">Carregando...</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
<div class="icon" style="color: #065f46;"><i class="fas fa-reply"></i></div>
                    <h3>Retornos</h3>
                </div>
                <div class="metric-content">
                    <p>Retornos na semana:</p>
                    <strong id="resumoRetornos">0</strong>
                    <p class="info-text" id="resumoRetornosDetalhe">Carregando...</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
<div class="icon" style="color: #b45309;"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h3>Propostas</h3>
                </div>
                <div class="metric-content">
                    <p>Propostas geradas:</p>
                    <strong id="resumoPropostas">0</strong>
                    <p class="info-text" id="resumoPropostasDetalhe">Carregando...</p>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria</h4>
                <div class="chart-container">
                    <canvas id="chartDiretoriaSemana"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento</h4>
                <div class="chart-container">
                    <canvas id="chartTipoAtendimento"></canvas>
                </div>
            </div>
        </div>

        <h2 class="timeline-header">Performance por Diretoria (Periodo)</h2>
        <div class="timeline-container" id="timelineDiretoriaSemana">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Carregando performance semanal...
            </div>
        </div>

        <h2 class="timeline-header">Origem dos Clientes</h2>
        <div class="timeline-container" id="timelineOrigem">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Carregando dados de origem...
            </div>
        </div>
    </div>
        <!-- ABA PANORAMA ESTOQUE -->
    <div id="panorama-estoque" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-boxes" style="color: #8b5cf6;"></i>
                Panorama Estoque
            </h1>
            <p class="dashboard-subtitle">Visão geral de vendas, estoque e performance - CAMINO</p>
        </div>

 <div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-header">
            <div class="icon" style="color: #10b981;"><i class="fas fa-bullseye"></i></div>
            <h3>Performance Unidades</h3>
        </div>
        <div class="metric-content">
            <p>Meta 2025: 74 unidades</p>
            <strong>43 unidades</strong>
            <p class="info-text">58,11% de atingimento</p>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-header">
            <div class="icon" style="color: #3b82f6;"><i class="fas fa-chart-line"></i></div>
            <h3>Performance VGV</h3>
        </div>
        <div class="metric-content">
            <p>Meta 2025: R$ 50.687.310</p>
            <strong>R$ 28.815.245</strong>
            <p class="info-text">56,85% de atingimento</p>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-header">
            <div class="icon" style="color: #f59e0b;"><i class="fas fa-calendar-check"></i></div>
            <h3>Outubro 2025</h3>
        </div>
        <div class="metric-content">
            <p>Meta: 10 unidades</p>
            <strong>6 unidades</strong>
            <p class="info-text">60% de atingimento</p>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-header">
            <div class="icon" style="color: #ef4444;"><i class="fas fa-box"></i></div>
            <h3>Estoque Total</h3>
        </div>
        <div class="metric-content">
            <p>Unidades disponíveis:</p>
            <strong>44 unidades</strong>
            <p class="info-text">De 194 unidades totais</p>
        </div>
    </div>
</div>

        <div class="charts-container">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> Vendas por Torre</h4>
                <div class="chart-container">
                    <canvas id="chartVendasTorre"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> Origem das Vendas</h4>
                <div class="chart-container">
                    <canvas id="chartOrigemVendas"></canvas>
                </div>
            </div>
        </div>

      <div class="timeline-card">
    <h4><i class="fas fa-check-circle" style="color: #10b981;"></i> UNIDADES VENDIDAS</h4>
    <h5>Total: 150 unidades</h5>
    
    <div class="list-group">
        <h5><i class="fas fa-building"></i> Por Torre</h5>
        <ul>
            <li>RESIDENCIAL: 109 unidades</li>
            <li>STUDIOS: 41 unidades</li>
        </ul>
    </div>
    
    <div class="list-group">
        <h5><i class="fas fa-ruler-combined"></i> Por Metragem</h5>
        <ul>
            <li>61m²: 19 unidades</li>
            <li>77m²: 70 unidades</li>
            <li>Studios: 100 unidade</li>
        </ul>
    </div>

    <div class="list-group">
        <h5><i class="fas fa-tag"></i> Por Origem</h5>
        <ul>
            <li>ONLINE: 9 unidades</li>
            <li>CARTEIRA: 12 unidades</li>
            <li>VEZ: 3 unidades</li>
            <li>PARCERIAS: 23 unidades</li>
        </ul>
    </div>
</div>

           <div class="timeline-card">
    <h4><i class="fas fa-warehouse" style="color: #3b82f6;"></i> ESTOQUE ATUAL</h4>
    <h5>Total: 194 unidades (44 disponíveis)</h5>
    
    <div class="list-group">
        <h5><i class="fas fa-building"></i> Unidades 61m²</h5>
        <ul>
            <li>10 Tipos</li>
            <li>1 Garden</li>
            <li style="color: #10b981; font-weight: bold;">Vendidas: 56 unidades</li>
        </ul>
    </div>
    
    <div class="list-group">
        <h5><i class="fas fa-building"></i> Unidades 77m²</h5>
        <ul>
            <li>16 Tipos</li>
            <li>2 Gardens</li>
            <li style="color: #10b981; font-weight: bold;">Vendidas: 52 unidades</li>
        </ul>
    </div>

    <div class="list-group">
        <h5><i class="fas fa-building"></i> Torre Studios</h5>
        <ul>
            <li>13 Tipos</li>
            <li style="color: #10b981; font-weight: bold;">Vendidas: 41 unidades</li>
        </ul>
    </div>
</div>
            <div class="timeline-card">
    <h4><i class="fas fa-trophy" style="color: #f59e0b;"></i> PERFORMANCE 2025</h4>
    
    <div class="list-group">
        <h5><i class="fas fa-cube"></i> Unidades</h5>
        <ul>
            <li>Meta: 74 unidades</li>
            <li>Realizado: 43 unidades</li>
            <li style="color: #10b981; font-weight: bold;">Atingimento: 58,11%</li>
        </ul>
    </div>
    
    <div class="list-group">
        <h5><i class="fas fa-money-bill-wave"></i> VGV</h5>
        <ul>
            <li>Meta: R$ 50.687.310</li>
            <li>Realizado: R$ 28.815.245</li>
            <li style="color: #3b82f6; font-weight: bold;">Atingimento: 56,85%</li>
        </ul>
    </div>
    
    <div class="list-group">
        <h5><i class="fas fa-calendar-alt"></i> Outubro/2025</h5>
        <ul>
            <li>Meta: 10 unidades</li>
            <li>Realizado: 6 unidades</li>
            <li style="color: #f59e0b; font-weight: bold;">Atingimento: 60%</li>
        </ul>
    </div>
</div>
        <div class="charts-container">
            <div class="chart-card">
                <h4><i class="fas fa-chart-line"></i> Performance de Atingimento</h4>
                <div class="chart-container">
                    <canvas id="chartPerformance"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-balance-scale"></i> Vendas vs Estoque</h4>
                <div class="chart-container">
                    <canvas id="chartVendasEstoque"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ABA CONTROLE DE ATENDIMENTOS -->
    <div id="controle-atendimentos" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-calendar-check" style="color: #3b82f6;"></i>
                Controle de Atendimentos
            </h1>
            <p class="dashboard-subtitle">Gestão completa de visitas e atendimentos comerciais</p>
        </div>

        <div class="filter-container">
            <div class="date-range">
                <div class="filter-group">
                    <label for="filterDataInicio"><i class="fas fa-calendar"></i> Data Início</label>
                    <input type="date" id="filterDataInicio" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="filterDataFim"><i class="fas fa-calendar"></i> Data Fim</label>
                    <input type="date" id="filterDataFim" class="filter-input">
                </div>
            </div>
            <div class="filter-group">
                <label for="filterDiretoria"><i class="fas fa-building"></i> Diretoria</label>
                <select id="filterDiretoria" class="filter-select">
                    <option value="todas">Todas as Directorias</option>
                    <option value="YUNY STORE">YUNY STORE</option>
                    <option value="PARCERIAS">PARCERIAS</option>
                    <option value="YUNY SELL">YUNY SELL</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterTipo"><i class="fas fa-tag"></i> Tipo de Visita</label>
                <select id="filterTipo" class="filter-select">
                    <option value="todos">Todos os Tipos</option>
                    <option value="Vez">Vez</option>
                    <option value="Indicação">Indicação</option>
                    <option value="Retorno">Retorno</option>
                    <option value="Ligação">Ligação</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="aplicarFiltros()">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
                <button class="btn btn-secondary" onclick="limparFiltros()">
                    <i class="fas fa-undo"></i> Limpar
                </button>
                <button class="btn btn-success" onclick="exportarParaCSV()">
                    <i class="fas fa-download"></i> Exportar CSV
                </button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
<div class="icon" style="color: #1e3a8a;"><i class="fas fa-calendar-check"></i></div>
                    <h3>TOTAL</h3>
                </div>
                <div class="metric-content">
                    <strong id="totalAtendimentos">0</strong>
                    <p class="info-text">No período selecionado</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
<div class="icon" style="color: #0f766e;"><i class="fas fa-store-alt"></i></div>
                    <h3>YUNY STORE</h3>
                </div>
                <div class="metric-content">
                    <strong id="totalStore">0</strong>
                    <p class="info-text">Atendimentos da Store</p>
                </div>
            </div>
                       <div class="metric-card">
                <div class="metric-header">
<div class="icon" style="color: #065f46;"><i class="fas fa-handshake"></i></div>
                    <h3>PARCERIAS</h3>
                </div>
                <div class="metric-content">
                    <strong id="totalParcerias">0</strong>
                    <p class="info-text">Atendimentos Parcerias</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
<div class="icon" style="color: #b45309;"><i class="fas fa-chart-line"></i></div>
                    <h3>YUNY SELL</h3>
                </div>
                <div class="metric-content">
                    <strong id="totalYunySell">0</strong>
                    <p class="info-text">Atendimentos Yuny Sell</p>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> Atendimentos por Diretoria</h4>
                <div class="chart-container">
                    <canvas id="chartDiretoriaAtendimentos"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> Atendimentos por Tipo</h4>
                <div class="chart-container">
                    <canvas id="chartTipoAtendimentos"></canvas>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Registro de Atendimentos</h3>
                <div class="table-actions">
                    <input type="text" id="searchInput" class="search-box" placeholder="Buscar..." onkeyup="filtrarTabela()">
                    <button class="btn btn-secondary" onclick="limparBusca()">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="atendimentos-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo de Visita</th>
                            <th>Corretor</th>
                            <th>Gerente</th>
                            <th>Mídia</th>
                            <th>Empresa</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaAtendimentos">
                        <tr>
                            <td colspan="6" class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Carregando dados da planilha...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="paginationInfo">
                    Mostrando 0 de 0 registros
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="mudarPagina(-1)" disabled id="btnPrev">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <button class="pagination-btn" onclick="mudarPagina(1)" id="btnNext">
                        Próxima <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ABA PIPELINE DE TRATATIVAS -->
    <div id="tratativas" class="dashboard">
        <div class="header-pipeline">
            <h1 class="dashboard-title">
                <i class="fas fa-filter" style="color: #3b82f6;"></i>
                Pipeline de Tratativas
            </h1>
            <p class="dashboard-subtitle">Visão detalhada do funil de vendas</p>
            <div id="pipelineStatusArea" style="margin-top: 10px; font-size: 0.9em;"></div> 
        </div>
        
        <div class="pipeline-container">
            <div class="pipeline-col vendido">
                <div class="col-header">
                    <h3>Unidades Vendidas</h3>
                    <div class="count">
                        <span>Total:</span>
                        <span class="count-value" id="countVendido">0</span>
                    </div>
                    <div class="vgv-total" id="vgvVendido">R$ 0</div>
                </div>
                <div class="col-content" id="pipelineVendido">
                    <!-- Conteúdo dinâmico -->
                </div>
            </div>

            <div class="pipeline-col processo">
                <div class="col-header">
                    <h3>Processo</h3>
                    <div class="count">
                        <span>Total:</span>
                        <span class="count-value" id="countProcesso">0</span>
                    </div>
                    <div class="vgv-total" id="vgvProcesso">R$ 0</div>
                </div>
                <div class="col-content" id="pipelineProcesso">
                    <!-- Conteúdo dinâmico -->
                </div>
            </div>
            
            <div class="pipeline-col proposta">
                <div class="col-header">
                    <h3>Propostas</h3>
                    <div class="count">
                        <span>Total:</span>
                        <span class="count-value" id="countProposta">0</span>
                    </div>
                    <div class="vgv-total" id="vgvProposta">R$ 0</div>
                </div>
                <div class="col-content" id="pipelineProposta">
                    <!-- Conteúdo dinâmico -->
                </div>
            </div>
            
            <div class="pipeline-col tratativa">
                <div class="col-header">
                    <h3>Tratativas</h3>
                    <div class="count">
                        <span>Total:</span>
                        <span class="count-value" id="countTratativa">0</span>
                    </div>
                    <div class="vgv-total" id="vgvTratativa">R$ 0</div>
                </div>
                <div class="col-content" id="pipelineTratativa">
                    <!-- Conteúdo dinâmico -->
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// ====================================================================
// CONFIGURAÇÕES GLOBAIS
// ====================================================================
let atendimentosData = [];
let atendimentosFiltrados = [];
let atendimentosPaginados = [];
let paginaAtual = 1;
const itensPorPagina = 10;

let chartDiretoriaAtendimentos = null;
let chartTipoAtendimentos = null;
let chartDiretoriaSemana = null;
let chartTipoAtendimentoSemana = null;
let dadosResumoFiltrados = [];

// URLs
const SHEET_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE4TL2UpdsZM43opfqqdDH2gdW_tzoHd4z-_7vxb6koicdOJWt6r-SoFVR0FWaAEs8UmJJGirQ0h0S/pub?gid=0&single=true&output=csv';
const PIPELINE_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdqDsD7zwfjYT3BkEpLe_qBUPXjmPkOhkbJTM-VbGF71l94gijdOLIgQz9CkebfjnSobOPvZalst51/pub?gid=0&single=true&output=csv';

// Colunas
const COL_DATA = 'Data';
const COL_TIPO = 'TIPO DE VISITA';
const COL_GERENTE = 'Gerente';
const COL_CORRETOR = 'Corretor de atendimento';
const COL_DIRETORIA = 'Empresa';
const COL_MIDIA = 'Mídia';

// Pipeline
const COL_PIPELINE_STATUS = 'STATUS';
const COL_PIPELINE_EMPRESA = 'EMPRESA';
const COL_PIPELINE_UNIDADE = 'UNIDADE';
const COL_PIPELINE_ORIGEM = 'ORIGEM';
const COL_PIPELINE_TOOLTIP = 'TOOLTIP';
const COL_PIPELINE_VGV = 'VGV';

const DIRETORIA_KEYS = [
    { key: 'STORE', label: 'STORE' },
    { key: 'YUNYSELL', label: 'YUNY SELL' },
    { key: 'PARCERIAS', label: 'PARCERIAS' },
    { key: 'DIRETORIA', label: 'DIRETORIA' }
];

// ====================================================================
// FUNÇÕES AUXILIARES
// ====================================================================
function parseDate(dateStr) {
    if (!dateStr) return null;
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        return new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00`);
    }
    if (dateStr.includes('-')) {
        return new Date(dateStr + 'T00:00:00');
    }
    return null;
}

function formatCurrency(value) {
    if (isNaN(value)) return 'R$ 0';
    return value.toLocaleString('pt-BR', { 
        style: 'currency', 
        currency: 'BRL', 
        minimumFractionDigits: 0, 
        maximumFractionDigits: 0 
    });
}

function csvToJson(csv) {
    const lines = csv.split('\n').filter(line => line.trim() !== '');
    if (lines.length <= 1) return { data: [], headersFound: {} };
    
    const firstLine = lines[0];
    let delimiter = firstLine.includes(';') ? ';' : (firstLine.includes('\t') ? '\t' : ',');
    
    const originalHeaders = firstLine.split(delimiter).map(h => h.trim().replace(/"/g, ''));
    const normalizedHeaders = originalHeaders.map(h => h.toUpperCase());
    const result = [];
    const headersFound = {};

    const expectedHeaders = [
        COL_DATA, COL_TIPO, COL_GERENTE, COL_CORRETOR, COL_DIRETORIA, COL_MIDIA,
        COL_PIPELINE_STATUS, COL_PIPELINE_EMPRESA, COL_PIPELINE_UNIDADE, 
        COL_PIPELINE_ORIGEM, COL_PIPELINE_TOOLTIP, COL_PIPELINE_VGV
    ];
    
    const headerIndexMap = {};

    expectedHeaders.forEach(expectedKey => {
        const keyToSearch = expectedKey.toUpperCase();
        const foundIndex = normalizedHeaders.findIndex(h => h === keyToSearch);
        
        if (foundIndex !== -1) {
            headerIndexMap[expectedKey] = foundIndex;
            headersFound[expectedKey] = true;
        }
    });

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line.length) continue;
        
        const currentline = line.split(delimiter);
        const obj = {};
        let isRowEmpty = true;

        for (const expectedKey of expectedHeaders) {
            const columnIndex = headerIndexMap[expectedKey];
            
            if (columnIndex !== undefined && currentline.length > columnIndex) {
                let value = currentline[columnIndex] || '';
                value = value.trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                
                obj[expectedKey] = value;
                if (value.length > 0) {
                    isRowEmpty = false;
                }
            }
        }
        
        if (!isRowEmpty) {
            result.push(obj);
        }
    }
    return { data: result, headersFound: headersFound };
}

function contarFrequencia(data, colKey) {
    const contagem = {};
    data.forEach(item => {
        const valor = (item[colKey] || 'NÃO ESPECIFICADO').trim().toUpperCase();
        contagem[valor] = (contagem[valor] || 0) + 1;
    });
    return contagem;
}

function mostrarNotificacao(mensagem, tipo = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${tipo}`;
    notification.textContent = mensagem;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// ====================================================================
// LÓGICA DO RESUMO DA SEMANA
// ====================================================================
function definirSemanaAtual() {
    const hoje = new Date();
    const segunda = new Date(hoje);
    segunda.setDate(hoje.getDate() - hoje.getDay() + (hoje.getDay() === 0 ? -6 : 1));
    
    const domingo = new Date(segunda);
    domingo.setDate(segunda.getDate() + 6);
    
    document.getElementById('resumoDataInicio').value = segunda.toISOString().split('T')[0];
    document.getElementById('resumoDataFim').value = domingo.toISOString().split('T')[0];
    
    aplicarFiltroResumo();
}

function aplicarFiltroResumo() {
    const dataInicioStr = document.getElementById('resumoDataInicio').value;
    const dataFimStr = document.getElementById('resumoDataFim').value;
    
    if (!dataInicioStr || !dataFimStr) {
        mostrarNotificacao('Selecione ambas as datas', 'warning');
        return;
    }
    
    const dataInicio = new Date(dataInicioStr + 'T00:00:00');
    const dataFim = new Date(dataFimStr + 'T23:59:59');
    
    dadosResumoFiltrados = atendimentosData.filter(item => {
        const itemDate = parseDate(item[COL_DATA]);
        return itemDate && itemDate >= dataInicio && itemDate <= dataFim;
    });
    
    atualizarResumoPeriodo(dataInicio, dataFim);
    calcularMetricasResumo();
    inicializarGraficosResumo();
    atualizarTimelineOrigem();
    atualizarPerformanceDiretoriaSemana();
    
    const totalAt = document.getElementById('totalAtendimentosSemana');
    if (totalAt) totalAt.textContent = dadosResumoFiltrados.length.toLocaleString('pt-BR');
}

function atualizarResumoPeriodo(inicio, fim) {
    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    const inicioStr = inicio.toLocaleDateString('pt-BR', options);
    const fimStr = fim.toLocaleDateString('pt-BR', options);
    document.getElementById('resumoPeriodo').textContent = `Período: ${inicioStr} a ${fimStr}`;
}

function calcularMetricasResumo() {
    let visitas = { total: 0, store: 0, yunysell: 0, parcerias: 0 };
    let indicacoes = { total: 0, store: 0, yunysell: 0, parcerias: 0 };
    let retornos = { total: 0, store: 0, yunysell: 0, parcerias: 0 };
    let propostas = { total: 0, store: 0, yunysell: 0, parcerias: 0 };
    
    dadosResumoFiltrados.forEach(item => {
        const tipo = (item[COL_TIPO] || '').toUpperCase();
        const diretoria = (item[COL_DIRETORIA] || '').toUpperCase();
        
        if (tipo.includes('VEZ')) {
            visitas.total++;
            if (diretoria.includes('STORE')) visitas.store++;
            else if (diretoria.includes('YUNY SELL') || diretoria.includes('YUNYSELL')) visitas.yunysell++;
            else if (diretoria.includes('PARCERIAS')) visitas.parcerias++;
        }
        else if (tipo.includes('INDI')) {
            indicacoes.total++;
            if (diretoria.includes('STORE')) indicacoes.store++;
            else if (diretoria.includes('YUNY SELL') || diretoria.includes('YUNYSELL')) indicacoes.yunysell++;
            else if (diretoria.includes('PARCERIAS')) indicacoes.parcerias++;
        }
        else if (tipo.includes('RETORNO')) {
            retornos.total++;
            if (diretoria.includes('STORE')) retornos.store++;
            else if (diretoria.includes('YUNY SELL') || diretoria.includes('YUNYSELL')) retornos.yunysell++;
            else if (diretoria.includes('PARCERIAS')) retornos.parcerias++;
        }
        else if (tipo.includes('PROPOSTA')) {
            propostas.total++;
            if (diretoria.includes('STORE')) propostas.store++;
            else if (diretoria.includes('YUNY SELL') || diretoria.includes('YUNYSELL')) propostas.yunysell++;
            else if (diretoria.includes('PARCERIAS')) propostas.parcerias++;
        }
    });
    
    function formatarDiretorias(metricas) {
        const partes = [];
        if (metricas.store > 0) partes.push(`Store: ${metricas.store}`);
        if (metricas.yunysell > 0) partes.push(`YunySell: ${metricas.yunysell}`);
        if (metricas.parcerias > 0) partes.push(`Parcerias: ${metricas.parcerias}`);
        return partes.join(' / ');
    }
    
    document.getElementById('resumoVisitas').textContent = visitas.total;
    document.getElementById('resumoVisitasDetalhe').textContent = formatarDiretorias(visitas) || 'Nenhuma diretoria';
    document.getElementById('resumoIndicacoes').textContent = indicacoes.total;
    document.getElementById('resumoIndicacoesDetalhe').textContent = formatarDiretorias(indicacoes) || 'Nenhuma diretoria';
    document.getElementById('resumoRetornos').textContent = retornos.total;
    document.getElementById('resumoRetornosDetalhe').textContent = formatarDiretorias(retornos) || 'Nenhuma diretoria';
    document.getElementById('resumoPropostas').textContent = propostas.total;
    document.getElementById('resumoPropostasDetalhe').textContent = formatarDiretorias(propostas) || 'Nenhuma diretoria';
}

function inicializarGraficosResumo() {
    const ctx1 = document.getElementById('chartDiretoriaSemana').getContext('2d');
    if (chartDiretoriaSemana) chartDiretoriaSemana.destroy();

    const diretorias = contarFrequencia(dadosResumoFiltrados, COL_DIRETORIA);
    chartDiretoriaSemana = new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: Object.keys(diretorias),
            datasets: [{
                data: Object.values(diretorias),
                backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    const ctx2 = document.getElementById('chartTipoAtendimento').getContext('2d');
    if (chartTipoAtendimentoSemana) chartTipoAtendimentoSemana.destroy();

    const tipos = contarFrequencia(dadosResumoFiltrados, COL_TIPO);
    chartTipoAtendimentoSemana = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: Object.keys(tipos),
            datasets: [{
                label: 'Quantidade',
                data: Object.values(tipos),
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });
}

function atualizarTimelineOrigem() {
    const timelineContainer = document.getElementById('timelineOrigem');
    timelineContainer.innerHTML = '';

    const visitasPorMidia = {};
    const indicacoesPorMidia = {};
    const retornosPorMidia = {};

    dadosResumoFiltrados.forEach(item => {
        const tipo = (item[COL_TIPO] || '').toUpperCase();
        const midia = item[COL_MIDIA] || 'Não Informada';

        if (tipo.includes('VEZ')) visitasPorMidia[midia] = (visitasPorMidia[midia] || 0) + 1;
        else if (tipo.includes('INDI')) indicacoesPorMidia[midia] = (indicacoesPorMidia[midia] || 0) + 1;
        else if (tipo.includes('RETORNO')) retornosPorMidia[midia] = (retornosPorMidia[midia] || 0) + 1;
    });

    function criarCard(titulo, icon, dados, cor) {
        if (Object.keys(dados).length === 0) return null;
        
        const total = Object.values(dados).reduce((a, b) => a + b, 0);
        const card = document.createElement('div');
        card.className = 'timeline-card';
        card.innerHTML = `
            <h4><i class="${icon}" style="color:${cor}"></i> ${titulo}</h4>
            <h5>Origem</h5>
            <p style="margin-bottom: 10px;">Total: ${total} atendimentos</p>
            <ul>
                ${Object.entries(dados)
                    .sort((a, b) => b[1] - a[1])
                    .map(([midia, count]) => `<li>${midia} → ${count}</li>`)
                    .join('')}
            </ul>
        `;
        return card;
    }

    const visitasCard = criarCard('Visitas', 'fas fa-map-marked-alt', visitasPorMidia, '#3b82f6');
    const indicacoesCard = criarCard('Indicações', 'fas fa-user-check', indicacoesPorMidia, '#6366f1');
    const retornosCard = criarCard('Retornos', 'fas fa-reply', retornosPorMidia, '#f59e0b');

    if (visitasCard) timelineContainer.appendChild(visitasCard);
    if (indicacoesCard) timelineContainer.appendChild(indicacoesCard);
    if (retornosCard) timelineContainer.appendChild(retornosCard);

    if (timelineContainer.children.length === 0) {
        timelineContainer.innerHTML = '<div class="loading">Nenhum dado de origem encontrado.</div>';
    }
}

function atualizarPerformanceDiretoriaSemana() {
    const container = document.getElementById('timelineDiretoriaSemana');
    container.innerHTML = '';

    if (!dadosResumoFiltrados || dadosResumoFiltrados.length === 0) {
        container.innerHTML = '<p class="warning-message">Nenhum dado encontrado para o período.</p>';
        return;
    }

    const diretorias = ['STORE', 'PARCERIAS', 'YUNY SELL'];
    const cores = { STORE: '#6366f1', PARCERIAS: '#f59e0b', 'YUNY SELL': '#06b6d4' };
    const metricas = {};

    diretorias.forEach(dir => {
        metricas[dir] = { visitas: 0, indicacoes: 0, retornos: 0, total: 0 };
    });

    dadosResumoFiltrados.forEach(item => {
        const tipo = (item[COL_TIPO] || '').toUpperCase();
        const dir = (item[COL_DIRETORIA] || '').toUpperCase();
        const diretoria = diretorias.find(d => dir.includes(d)) || 'OUTROS';

        if (!metricas[diretoria]) return;

        if (tipo.includes('VEZ')) metricas[diretoria].visitas++;
        else if (tipo.includes('INDI')) metricas[diretoria].indicacoes++;
        else if (tipo.includes('RETORNO')) metricas[diretoria].retornos++;

        metricas[diretoria].total = metricas[diretoria].visitas + metricas[diretoria].indicacoes + metricas[diretoria].retornos;
    });

    diretorias.forEach(dir => {
        const data = metricas[dir];
        const card = document.createElement('div');
        card.className = 'timeline-card';
        card.innerHTML = `
            <h4><i class="fas fa-circle" style="color:${cores[dir]}"></i> ${dir}</h4>
            <h5>Performance no Periodo</h5>
            <ul>
                <li>Visitas: ${data.visitas}</li>
                <li>Indicações: ${data.indicacoes}</li>
                <li>Retornos: ${data.retornos}</li>
                <li>Total: ${data.total}</li>
            </ul>
        `;
        container.appendChild(card);
    });
}

// ====================================================================
// LÓGICA DE ATENDIMENTOS
// ====================================================================
async function carregarDadosPlanilha() {
    const tabelaBody = document.getElementById('tabelaAtendimentos');
    const statusArea = document.getElementById('statusArea');
    
    statusArea.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados de Atendimentos...</div>`;
    tabelaBody.innerHTML = `<tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>`;

    try {
        const response = await fetch(SHEET_DATA_URL);

        if (!response.ok) {
            throw new Error(`Erro: ${response.statusText}. Status: ${response.status}`);
        }

        const csvText = await response.text();
        const { data, headersFound } = csvToJson(csvText);
        atendimentosData = data;

        if (!headersFound[COL_DATA]) {
            statusArea.innerHTML = `<div class="error-message"><i class="fas fa-times-circle"></i> ERRO DE CABEÇALHO: Não foi possível encontrar a coluna **'${COL_DATA}'** no seu CSV. Verifique o nome exato da coluna no seu Google Sheets (deve ser 'Data').</div>`;
            tabelaBody.innerHTML = `<tr><td colspan="6">Falha ao identificar a coluna de Data.</td></tr>`;
            return;
        }

        if (atendimentosData.length === 0) {
            statusArea.innerHTML = `<div class="warning-message"><i class="fas fa-exclamation-triangle"></i> Planilha carregada. Nenhum registro com dados válidos encontrado (Verifique se as colunas estão preenchidas).</div>`;
            tabelaBody.innerHTML = `<tr><td colspan="6">Nenhum registro encontrado.</td></tr>`;
            return;
        }

        statusArea.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i> Dados de Atendimentos carregados. Total: **${atendimentosData.length}** registros.</div>`;
        
        // Inicializar resumo da semana após carregar dados
        definirSemanaAtual();
        limparFiltros(true);
        
    } catch (error) {
        console.error('Erro no carregamento de dados:', error);
        tabelaBody.innerHTML = `<tr><td colspan="6" class="error-message">
            <i class="fas fa-exclamation-triangle"></i> Falha ao carregar os dados.
        </td></tr>`;
        statusArea.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Erro: Não foi possível buscar o CSV de Atendimentos. Detalhe: ${error.message}</div>`;
    }
}

function aplicarFiltros() {
    const dataInicioStr = document.getElementById('filterDataInicio').value;
    const dataFimStr = document.getElementById('filterDataFim').value;
    const diretoria = document.getElementById('filterDiretoria').value;
    const tipo = document.getElementById('filterTipo').value;

    const dataInicio = dataInicioStr ? new Date(dataInicioStr + 'T00:00:00') : null;
    const dataFim = dataFimStr ? new Date(dataFimStr + 'T23:59:59') : null;

    atendimentosFiltrados = atendimentosData.filter(item => {
        const itemDate = parseDate(item[COL_DATA]);
        let passaData = true;
        
        if (dataInicio && itemDate && itemDate < dataInicio) passaData = false;
        if (dataFim && itemDate && itemDate > dataFim) passaData = false;

        const diretoriaKey = (item[COL_DIRETORIA] || '').trim().toUpperCase(); 
        let passaDiretoria = diretoria === 'todas' || diretoriaKey === diretoria.toUpperCase();

        const tipoKey = (item[COL_TIPO] || '').trim().toUpperCase(); 
        let passaTipo = tipo === 'todos' || tipoKey === tipo.toUpperCase();

        return passaData && passaDiretoria && passaTipo;
    });

    document.getElementById('searchInput').value = '';
    paginaAtual = 1;
    filtrarTabela();
}

function limparFiltros(apenasSetarDatas = false) {
    document.getElementById('filterDiretoria').value = 'todas';
    document.getElementById('filterTipo').value = 'todos';

    const dataFim = new Date();
    const dataInicio = new Date();
    dataInicio.setDate(dataInicio.getDate() - 30);
    
    document.getElementById('filterDataInicio').value = dataInicio.toISOString().split('T')[0];
    document.getElementById('filterDataFim').value = dataFim.toISOString().split('T')[0];
    
    if (!apenasSetarDatas) {
         aplicarFiltros();
    }
}

function limparBusca() {
    document.getElementById('searchInput').value = '';
    filtrarTabela();
}

function filtrarTabela() {
    const termoBusca = document.getElementById('searchInput').value.toLowerCase();
    
    atendimentosPaginados = atendimentosFiltrados.filter(item => {
        const itemString = (item[COL_DATA] || '') + ' ' +
                           (item[COL_TIPO] || '') + ' ' +
                           (item[COL_CORRETOR] || '') + ' ' +
                           (item[COL_GERENTE] || '') + ' ' +
                           (item[COL_MIDIA] || '') + ' ' +
                           (item[COL_DIRETORIA] || '');
        
        return itemString.toLowerCase().includes(termoBusca);
    });

    atualizarMetricas(atendimentosPaginados);
    inicializarGraficosAtendimentos(atendimentosPaginados);
    
    paginaAtual = 1;
    popularTabela(atendimentosPaginados);
}

function popularTabela(data) {
    const tabelaBody = document.getElementById('tabelaAtendimentos');
    tabelaBody.innerHTML = '';

    const totalPaginas = Math.ceil(data.length / itensPorPagina);
    paginaAtual = Math.min(Math.max(1, paginaAtual), totalPaginas || 1);

    const inicio = (paginaAtual - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const dadosPagina = data.slice(inicio, fim);

    if (dadosPagina.length === 0 && data.length > 0 && paginaAtual > 1) {
        paginaAtual = totalPaginas;
        popularTabela(data);
        return;
    }

    if (dadosPagina.length === 0) {
        tabelaBody.innerHTML = `<tr><td colspan="6">Nenhum registro encontrado.</td></tr>`;
    } else {
        dadosPagina.forEach(item => {
            const diretoria = (item[COL_DIRETORIA] || 'N/A').toString();
            const tipo = item[COL_TIPO] || 'N/A';
            const corretor = item[COL_CORRETOR] || 'N/A';
            const gerente = item[COL_GERENTE] || 'N/A';
            const midia = item[COL_MIDIA] || '';
            const dataFormatada = item[COL_DATA] || 'N/A';

            const diretoriaClass = 'diretoria-' + diretoria.toLowerCase().replace(/[^a-z0-9]/g, '');

            const row = `
                <tr>
                    <td>${dataFormatada}</td>
                    <td><span class="tipo-badge">${tipo}</span></td>
                    <td>${corretor}</td>
                    <td>${gerente}</td>
                    <td>${ midia ? `<span class="diretoria-badge ${diretoriaClass}">${midia}</span>` : '' }</td>
                    <td><span class="diretoria-badge ${diretoriaClass}">${diretoria}</span></td>
                </tr>
            `;
            tabelaBody.innerHTML += row;
        });
    }

    document.getElementById('paginationInfo').textContent = `Mostrando ${inicio + 1} a ${inicio + dadosPagina.length} de ${data.length} registros`;
    document.getElementById('btnPrev').disabled = paginaAtual === 1 || data.length === 0;
    document.getElementById('btnNext').disabled = paginaAtual === totalPaginas || data.length === 0;
}

function mudarPagina(direcao) {
    paginaAtual += direcao;
    popularTabela(atendimentosPaginados);
}

function atualizarMetricas(data) {
    const total = data.length;
    const store = data.filter(item => (item[COL_DIRETORIA] || '').toUpperCase() === 'YUNY STORE').length;
    const parcerias = data.filter(item => (item[COL_DIRETORIA] || '').toUpperCase() === 'PARCERIAS').length;
    const yunySell = data.filter(item => (item[COL_DIRETORIA] || '').toUpperCase() === 'YUNY SELL').length;

    document.getElementById('totalAtendimentos').textContent = total;
    document.getElementById('totalStore').textContent = store;
    document.getElementById('totalParcerias').textContent = parcerias;
    document.getElementById('totalYunySell').textContent = yunySell;
}

function inicializarGraficosAtendimentos(data = atendimentosPaginados) {
    // Gráfico de Diretoria (Pie)
    const ctx1 = document.getElementById('chartDiretoriaAtendimentos').getContext('2d');
    if (chartDiretoriaAtendimentos) chartDiretoriaAtendimentos.destroy();

    const diretorias = contarFrequencia(data, COL_DIRETORIA);
    const labels = Object.keys(diretorias);
    const chartData = Object.values(diretorias);
    const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];

    chartDiretoriaAtendimentos = new Chart(ctx1, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: chartData,
                backgroundColor: colors.slice(0, labels.length)
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    // Gráfico de Tipo (Bar)
    const ctx2 = document.getElementById('chartTipoAtendimentos').getContext('2d');
    if (chartTipoAtendimentos) chartTipoAtendimentos.destroy();
    
    const tipos = contarFrequencia(data, COL_TIPO);
    const tipoLabels = Object.keys(tipos);
    const tipoData = Object.values(tipos);

    chartTipoAtendimentos = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: tipoLabels,
            datasets: [{
                label: 'Atendimentos',
                data: tipoData,
                backgroundColor: '#3b82f6'
            }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false, 
            scales: { y: { beginAtZero: true } }
        }
    });
}

function exportarParaCSV() {
    const COLUNAS_EXPORTAR = [COL_DATA, COL_TIPO, COL_CORRETOR, COL_GERENTE, COL_DIRETORIA];
    const CABECALHOS_EXPORTAR = ['Data', 'Tipo de Visita', 'Corretor', 'Gerente', 'Empresa'];

    if (atendimentosPaginados.length === 0) {
        alert("Não há dados filtrados para exportar.");
        return;
    }

    let csvContent = CABECALHOS_EXPORTAR.map(h => `"${h}"`).join(";") + "\n";

    atendimentosPaginados.forEach(item => {
        const row = COLUNAS_EXPORTAR.map(header => {
            let value = item[header] || '';
            return `"${String(value).replace(/"/g, '""').replace(/;/, ',').replace(/\n/g, ' ')}"`;
        }).join(";");
        csvContent += row + "\n";
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "Atendimentos_Exportados.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
    // ====================================================================
// LÓGICA DE PIPELINE
// ====================================================================
function renderPipelineColumn(statusKey, targetElement) {
    targetElement.innerHTML = '';
    const directorateElements = {};

    DIRETORIA_KEYS.forEach(d => {
        const idBase = statusKey.toLowerCase() + d.key;
        const vgvId = 'vgv' + idBase.charAt(0).toUpperCase() + idBase.slice(1);

        const diretoriaDiv = document.createElement('div');
        diretoriaDiv.className = 'pipeline-diretoria';
        
        diretoriaDiv.innerHTML = `
            <h4>${d.label} <span class="diretoria-vgv" id="${vgvId}">R$ 0</span></h4>
            <div id="${idBase}" class="diretoria-items"></div>
        `;
        targetElement.appendChild(diretoriaDiv);
        
        directorateElements[d.key] = diretoriaDiv;
    });
    
    return directorateElements;
}

async function carregarDadosPipeline() {
    const pipelineStatusArea = document.getElementById('pipelineStatusArea');
    pipelineStatusArea.innerHTML = '<span class="text-warning"><i class="fas fa-spinner fa-spin"></i> Carregando dados do Pipeline...</span>';

    try {
        const response = await fetch(PIPELINE_DATA_URL);
        if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`);
        
        const csvText = await response.text();
        const { data: dadosPipeline, headersFound } = csvToJson(csvText);
        
        if (!headersFound[COL_PIPELINE_UNIDADE] || !headersFound[COL_PIPELINE_STATUS]) {
             pipelineStatusArea.innerHTML = `<span class="error-message"><i class="fas fa-exclamation-triangle"></i> ERRO DE CABEÇALHO: Colunas **STATUS** e/ou **UNIDADE** não encontradas no CSV do Pipeline.</span>`;
             return;
        }

        popularPipeline(dadosPipeline);
        
        if (dadosPipeline.length > 0) {
            pipelineStatusArea.innerHTML = `<span class="success-message"><i class="fas fa-check-circle"></i> Pipeline carregado com sucesso. **${dadosPipeline.length}** itens encontrados.</span>`;
        } else {
             pipelineStatusArea.innerHTML = `<span class="warning-message"><i class="fas fa-exclamation-triangle"></i> **Pipeline vazio**. Nenhum dado válido encontrado.</span>`;
        }

    } catch (error) {
        console.error('Erro ao carregar dados do pipeline:', error);
        pipelineStatusArea.innerHTML = `<span class="error-message"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar o Pipeline. Detalhe: ${error.message}</span>`;
    }
}

function popularPipeline(dados) {
    // 1. Containers HTML e Geração da Estrutura
    const pipelineContainers = {
        VENDIDO: document.getElementById('pipelineVendido'),
        PROCESSO: document.getElementById('pipelineProcesso'),
        PROPOSTA: document.getElementById('pipelineProposta'),
        TRATATIVA: document.getElementById('pipelineTratativa')
    };
    
    // Renderiza a estrutura de subcategorias
    const vendidoParents = renderPipelineColumn('vendido', pipelineContainers.VENDIDO);
    const processoParents = renderPipelineColumn('processo', pipelineContainers.PROCESSO);
    const propostaParents = renderPipelineColumn('proposta', pipelineContainers.PROPOSTA);
    const tratativaParents = renderPipelineColumn('tratativa', pipelineContainers.TRATATIVA);
    
    // 2. Inicializa a Estrutura de Tracking
    const columns = {};
    Object.keys(pipelineContainers).forEach(status => {
        const parentMap = status === 'VENDIDO' ? vendidoParents : 
                          status === 'PROCESSO' ? processoParents :
                          status === 'PROPOSTA' ? propostaParents :
                          tratativaParents;

        columns[status] = { 
            count: 0, 
            vgvSum: 0, 
            elements: DIRETORIA_KEYS.reduce((acc, d) => {
                const idBase = status.toLowerCase() + d.key;
                acc[d.key] = {
                    total: 0,
                    vgv: 0,
                    element: document.getElementById(idBase),
                    vgvElement: document.getElementById('vgv' + idBase.charAt(0).toUpperCase() + idBase.slice(1)),
                    parentElement: parentMap[d.key]
                };
                return acc;
            }, {})
        };
    });

    // 3. Processar os dados e popular os cards
    dados.forEach(item => {
        const status = (item[COL_PIPELINE_STATUS] || '').toUpperCase();
        const nomeUnidade = item[COL_PIPELINE_UNIDADE] || 'Unidade Desconhecida';
        const origem = item[COL_PIPELINE_ORIGEM] || 'Não Informada'; 
        const tooltipContent = item[COL_PIPELINE_TOOLTIP] || 'Detalhe não informado.'; 
        const vgvRaw = item[COL_PIPELINE_VGV] || '0';
        
        let vgvClean = vgvRaw.replace(/[^0-9,\.-]/g, '');
        let vgvFloat = parseFloat(vgvClean.replace(/\./g, '').replace(/,/g, '.')); 
        
        if (isNaN(vgvFloat)) {
            vgvFloat = parseFloat(vgvClean.replace(/,/g, ''));
        }
        
        const vgvValue = isNaN(vgvFloat) ? 0 : vgvFloat;

        // Ignora a linha se o status for inválido ou a unidade for desconhecida
        if (nomeUnidade === 'Unidade Desconhecida' || !columns[status]) return; 

        const empresa = (item[COL_PIPELINE_EMPRESA] || 'NAOESPECIFICADO').toUpperCase().replace(/\s/g, ''); 
        const empresaKey = empresa.includes('SELL') ? 'YUNYSELL' : empresa;

        const columnData = columns[status];
        const diretoriaData = columnData.elements[empresaKey];
        
        if (diretoriaData && diretoriaData.element) {
            columnData.count++;
            columnData.vgvSum += vgvValue;
            diretoriaData.total++;
            diretoriaData.vgv += vgvValue;
            
            let statusClass = '';
            if (status === 'VENDIDO') statusClass = 'tratativa-row-vendido';
            else if (status === 'PROCESSO') statusClass = 'tratativa-row-processo';
            else if (status === 'PROPOSTA') statusClass = 'tratativa-row-proposta';
            else if (status === 'TRATATIVA') statusClass = 'tratativa-row-tratativa';
            
            const itemElement = document.createElement('div');
            itemElement.className = `tratativa-row ${statusClass}`;
            itemElement.setAttribute('data-tooltip', tooltipContent);

            itemElement.innerHTML = `
                <span class="row-unit" title="${nomeUnidade}">${nomeUnidade}</span>
                <span class="row-origin" title="Origem: ${origem}">${origem}</span>
            `;

            diretoriaData.element.appendChild(itemElement);
        }
    });

    // 4. Atualizar as contagens totais, VGV e VISIBILIDADE
    
    // VGV total do Pipeline (topo da coluna)
    document.getElementById('countVendido').textContent = columns.VENDIDO.count;
    document.getElementById('vgvVendido').textContent = formatCurrency(columns.VENDIDO.vgvSum);
    document.getElementById('countProcesso').textContent = columns.PROCESSO.count;
    document.getElementById('vgvProcesso').textContent = formatCurrency(columns.PROCESSO.vgvSum);
    document.getElementById('countProposta').textContent = columns.PROPOSTA.count;
    document.getElementById('vgvProposta').textContent = formatCurrency(columns.PROPOSTA.vgvSum);
    document.getElementById('countTratativa').textContent = columns.TRATATIVA.count;
    document.getElementById('vgvTratativa').textContent = formatCurrency(columns.TRATATIVA.vgvSum);
    
    // VGV por Diretoria (subtítulos) e Lógica de Ocultamento
    Object.keys(columns).forEach(status => {
        Object.values(columns[status].elements).forEach(diretoria => {
             if(diretoria.vgvElement) {
                diretoria.vgvElement.textContent = formatCurrency(diretoria.vgv);
             }
             
             if (diretoria.total === 0 && diretoria.parentElement) {
                 diretoria.parentElement.style.display = 'none';
             } else if (diretoria.parentElement) {
                 diretoria.parentElement.style.display = 'block';
             }
        });
    });
}

// ====================================================================
// FUNÇÕES DE GRÁFICOS ESTÁTICOS
// ====================================================================
function inicializarGraficosEstoque() {
    const ctx1 = document.getElementById('chartVendasTorre').getContext('2d');
    if (ctx1) {
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['61m²', '77m²', 'Studios'],
                datasets: [{
                    data: [57, 52, 41],
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Vendas por Torre - 150 unidades'
                    }
                }
            }
        });
    }
    const ctx2 = document.getElementById('chartOrigemVendas').getContext('2d');
    if (ctx2) {
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['ONLINE', 'CARTEIRA', 'VEZ', 'PARCERIAS'],
                datasets: [{
                    label: 'Unidades Vendidas',
                    data: [9, 12, 3, 23],
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Unidades'
                        }
                    }
                }
            }
        });
    }
    const ctx3 = document.getElementById('chartPerformance').getContext('2d');
    if (ctx3) {
        new Chart(ctx3, {
            type: 'doughnut',
            data: {
                labels: ['Atingido', 'Restante'],
                datasets: [{
                    data: [43, 31], // 74 - 43 = 31
                    backgroundColor: ['#10b981', '#e5e7eb']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Performance Unidades 2025 - 58,11%'
                    }
                }
            }
        });
    }
    const ctx4 = document.getElementById('chartVendasEstoque').getContext('2d');
    if (ctx4) {
        new Chart(ctx4, {
            type: 'pie',
            data: {
                labels: ['Vendidas', 'Em Estoque'],
                datasets: [{
                    data: [150, 44],
                    backgroundColor: ['#10b981', '#3b82f6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Total: 194 unidades'
                    }
                }
            }
        });
    }
}

// ====================================================================
// FUNÇÃO DE ATUALIZAÇÃO DA YUNY SELL
// ====================================================================
function atualizarYunySellControle() {
    try {
        const yunyAtendimentos = atendimentosData.filter(item => {
            const valor = (item[COL_DIRETORIA] || '').toUpperCase().trim();
            return valor === 'YUNY SELL';
        });
        const totalElem = document.getElementById('totalYunySell');
        if (totalElem) totalElem.textContent = yunyAtendimentos.length.toLocaleString('pt-BR');
    } catch (e) {
        console.error('Erro ao calcular total da Yuny Sell:', e);
    }
}

// ====================================================================
// INICIALIZAÇÃO FINAL
// ====================================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando dashboard...');
    
    // Configurar abas
    const tabs = document.querySelectorAll('.tab');
    const dashboards = document.querySelectorAll('.dashboard');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const target = this.getAttribute('data-target');
            
            tabs.forEach(t => t.classList.remove('active'));
            dashboards.forEach(d => d.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(target).classList.add('active');
            
            // Inicializar gráficos quando mudar de aba
            if (target === 'resumo') {
                // A aba resumo agora é dinâmica, não precisa inicializar gráficos estáticos
            }
            if (target === 'panorama-estoque') inicializarGraficosEstoque();
            if (target === 'controle-atendimentos') {
                if(atendimentosPaginados.length > 0) {
                    inicializarGraficosAtendimentos(); 
                }
            }
            if (target === 'tratativas') carregarDadosPipeline(); 
        });
    });

    // Configurar datas padrão
    limparFiltros(true); 

    // Sistema de tooltips 
    document.addEventListener('mouseover', function(e) {
        let targetElement = e.target;
        while (targetElement && !targetElement.classList.contains('tratativa-row') && targetElement !== document.body) {
            targetElement = targetElement.parentElement;
        }

        if (targetElement && targetElement.classList.contains('tratativa-row') && targetElement.hasAttribute('data-tooltip')) {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip show';
            tooltip.textContent = targetElement.getAttribute('data-tooltip');
            document.body.appendChild(tooltip);
            
            const rect = targetElement.getBoundingClientRect();
            
            let leftPos = rect.left + rect.width / 2 - tooltip.offsetWidth / 2;
            leftPos = Math.min(leftPos, window.innerWidth - tooltip.offsetWidth - 10);
            leftPos = Math.max(leftPos, 10);

            tooltip.style.left = leftPos + 'px';
            tooltip.style.top = (rect.bottom + 10) + 'px';
            
            targetElement._currentTooltip = tooltip;
        }
    });

    document.addEventListener('mouseout', function(e) {
        let targetElement = e.target;
        while (targetElement && !targetElement.classList.contains('tratativa-row') && targetElement !== document.body) {
            targetElement = targetElement.parentElement;
        }
        if (targetElement && targetElement.classList.contains('tratativa-row') && targetElement._currentTooltip) {
            targetElement._currentTooltip.remove();
            targetElement._currentTooltip = null;
        }
    });

    // Inicializar gráficos estáticos iniciais
    inicializarGraficosEstoque();

    // Carregar dados da planilha ao iniciar o DOM
    carregarDadosPlanilha();
    
    // Carregar dados do pipeline ao iniciar o DOM
    carregarDadosPipeline();

    // Atualizar Yuny Sell após carregar dados
    setTimeout(atualizarYunySellControle, 3000);
});
</script>
</body>
</html>
