<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard Camino</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{
            --primary:#3b82f6; --secondary:#6366f1; --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
            --dark:#1f2937; --light:#f9fafb; --gray:#6b7280; --border:#e5e7eb;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
        body{background:#f3f4f6;color:var(--dark);line-height:1.6;}
        .container{max-width:1400px;margin:0 auto;padding:20px;}
        header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:20px;}
        .logo{font-size:24px;font-weight:700;color:var(--primary);display:flex;align-items:center;gap:10px;}
        .logo-img{height:40px;width:auto;border-radius:6px;object-fit:contain;transition:transform .25s;}
        .logo-img:hover{transform:scale(1.05);opacity:.95;}
        .tabs{display:flex;gap:10px;flex-wrap:wrap;}
        .tab{padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;border:1px solid var(--border);}
        .tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
        .dashboard{display:none;animation:fadeIn .35s ease;}
        .dashboard.active{display:block;}
        .dashboard-title{font-size:28px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:12px;}
        .dashboard-subtitle{color:var(--gray);font-size:16px;}
        .filter-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px;padding:20px;background:#fff;border-radius:12px;box-shadow:var(--card-shadow);}
        .filter-group{display:flex;flex-direction:column;gap:8px;}
        .filter-group label{font-weight:600;color:var(--dark);font-size:.9rem;display:flex;align-items:center;gap:8px;}
        .filter-select, .filter-input{padding:10px 12px;border-radius:6px;border:1px solid var(--border);background:white;font-size:.9rem;}
        .filter-actions{display:flex;gap:10px;align-items:flex-end;}
        .btn{padding:10px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:8px;}
        .btn-primary{background:var(--primary);color:white;}
        .btn-secondary{background:var(--gray);color:white;}
        .btn-success{background:var(--success);color:white;}
        .metrics-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:20px;margin-bottom:30px;}
        .metric-card{background:white;border-radius:12px;padding:20px;box-shadow:var(--card-shadow);transition:transform .2s;}
        .metric-header{display:flex;align-items:center;margin-bottom:12px;gap:12px;}
        .metric-header .icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--light);}
        .metric-content p{color:var(--gray);margin-bottom:4px;}
        .metric-content strong{display:block;font-size:1.5rem;font-weight:700;color:var(--dark);}
        .charts-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:30px;}
        .chart-card{background:white;border-radius:12px;padding:20px;box-shadow:var(--card-shadow);}
        .chart-container{position:relative;height:300px;width:100%;}
        .timeline-container{display:flex;flex-wrap:nowrap;overflow-x:auto;gap:20px;padding-bottom:10px;margin-bottom:30px;scroll-behavior:smooth;}
        .timeline-card{flex:0 0 300px;background:white;border-radius:12px;padding:20px;box-shadow:var(--card-shadow);}
        .timeline-card h4{font-size:1rem;color:var(--primary);font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
        .timeline-card ul{list-style:none;padding-left:0;margin-top:10px;}
        .pipeline-container{display:flex;gap:20px;overflow-x:auto;padding-bottom:10px;width:100%;}
        .pipeline-col{flex:0 0 320px;background:white;border-radius:12px;box-shadow:var(--card-shadow);display:flex;flex-direction:column;max-height:80vh;}
        .col-header{padding:15px;border-bottom:2px solid var(--border);display:flex;flex-direction:column;align-items:flex-start;background:var(--light);border-top-left-radius:12px;border-top-right-radius:12px;}
        .col-header h3{font-size:1.1rem;font-weight:700;margin-bottom:5px;}
        .col-header .count-value{background:var(--primary);color:white;padding:2px 8px;border-radius:999px;font-size:.8rem;font-weight:700;}
        .col-content{padding:10px;overflow-y:auto;flex-grow:1;background:#f9fafb;}
        .tratativa-row{position:relative;cursor:pointer;transition:background-color .2s;padding:8px;border-radius:6px;margin-bottom:6px;background:white;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:.9rem;}
        .tooltip{position:absolute;background:var(--dark);color:white;padding:12px;border-radius:8px;font-size:.85rem;max-width:250px;z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s;pointer-events:none;}
        .tooltip.show{opacity:1;visibility:visible;}
        .loading{text-align:center;padding:20px;color:var(--primary);}
        .error-message{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:12px;border-radius:8px;margin:10px 0;}
        .success-message{background:#d1fae5;border:1px solid #a7f3d0;color:#065f46;padding:12px;border-radius:8px;margin:10px 0;}
        .warning-message{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:12px;border-radius:8px;margin:10px 0;}
        @media (max-width: 768px){ .metrics-grid{grid-template-columns:1fr;} .charts-container{grid-template-columns:1fr;} .timeline-card{width:280px;} }
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">
            <img src="https://caminoaltodaboavista.touchapp.com.br/img/logo.png" alt="Logo Camino" class="logo-img">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard Camino</span>
        </div>
        <div class="tabs">
            <div class="tab active" data-target="resumo">Resumo da Semana</div>
            <div class="tab" data-target="resumo-mes">Resumo do Mês</div>
            <div class="tab" data-target="historico-mes">Histórico Mensal</div>
            <div class="tab" data-target="panorama-estoque">Panorama Estoque</div>
            <div class="tab" data-target="controle-atendimentos">Controle de Atendimentos</div>
            <div class="tab" data-target="tratativas">Pipeline de Tratativas</div>
        </div>
    </header>

    <div id="statusArea"></div>

    <!-- ABA RESUMO DA SEMANA -->
    <div id="resumo" class="dashboard active">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-bullhorn" style="color: #f59e0b;"></i>
                Resumo da Semana
            </h1>
            <p class="dashboard-subtitle" id="resumoPeriodo">Carregando período...</p>
        </div>

        <!-- FILTRO DE PERÍODO -->
        <div class="filter-container">
            <div class="date-range">
                <div class="filter-group">
                    <label for="resumoDataInicio"><i class="fas fa-calendar"></i> Data Início</label>
                    <input type="date" id="resumoDataInicio" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="resumoDataFim"><i class="fas fa-calendar"></i> Data Fim</label>
                    <input type="date" id="resumoDataFim" class="filter-input">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="aplicarFiltroResumo()">
                    <i class="fas fa-filter"></i> Aplicar Filtro
                </button>
                <button class="btn btn-secondary" onclick="definirSemanaAtual()">
                    <i class="fas fa-calendar-week"></i> Semana Atual
                </button>
            </div>
        </div>

        <!-- MÉTRICAS DINÂMICAS -->
        <div class="metrics-grid">

            <div class="metric-card" id="cardTotalAtendimentosSemana">
                <div class="metric-header">
                    <div class="icon" style="color: #2563eb;"><i class="fas fa-users"></i></div>
                    <h3>TOTAL</h3>
                </div>
                <div class="metric-content">
                    <p>Total da semana:</p>
                    <strong id="totalAtendimentosSemana">0</strong>
                    <p class="info-text">Atendimentos registrados no período</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color:#3b82f6;"><i class="fas fa-door-open"></i></div>
                    <h3>Vez</h3>
                </div>
                <div class="metric-content">
                    <p>Total de visitas:</p>
                    <strong id="resumoVisitas">0</strong>
                    <p class="info-text" id="resumoVisitasDetalhe">Carregando...</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color:#6366f1;"><i class="fas fa-user-friends"></i></div>
                    <h3>Indicações</h3>
                </div>
                <div class="metric-content">
                    <p>Total de indicações:</p>
                    <strong id="resumoIndicacoes">0</strong>
                    <p class="info-text" id="resumoIndicacoesDetalhe">Carregando...</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color:#f59e0b;"><i class="fas fa-reply"></i></div>
                    <h3>Retornos</h3>
                </div>
                <div class="metric-content">
                    <p>Retornos na semana:</p>
                    <strong id="resumoRetornos">0</strong>
                    <p class="info-text" id="resumoRetornosDetalhe">Carregando...</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color:#ef4444;"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h3>Propostas</h3>
                </div>
                <div class="metric-content">
                    <p>Propostas geradas:</p>
                    <strong id="resumoPropostas">0</strong>
                    <p class="info-text" id="resumoPropostasDetalhe">Carregando...</p>
                </div>
            </div>

        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria</h4>
                <div class="chart-container">
                    <canvas id="chartDiretoriaSemana"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento</h4>
                <div class="chart-container">
                    <canvas id="chartTipoAtendimento"></canvas>
                </div>
            </div>
        </div>

        <h2 class="timeline-header">Performance por Diretoria (Periodo)</h2>
        <div class="timeline-container" id="timelineDiretoriaSemana">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando performance semanal...</div>
        </div>

        <h2 class="timeline-header">Origem dos Clientes</h2>
        <div class="timeline-container" id="timelineOrigem">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados de origem...</div>
        </div>
    </div>

    <!-- ABA RESUMO DO MÊS (mantida) -->
    <div id="resumo-mes" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title"><i class="fas fa-calendar-alt" style="color: #10b981;"></i> Resumo do Mês</h1>
            <p class="dashboard-subtitle" id="resumoMesSub">Carregando...</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#2563eb;"><i class="fas fa-users"></i></div><h3>TOTAL</h3></div>
                <div class="metric-content"><p>Total do mês:</p><strong id="totalAtendimentosMes">0</strong></div>
            </div>
            <!-- outros cards (mantidos do original) -->
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#3b82f6;"><i class="fas fa-door-open"></i></div><h3>Visitas Espontâneas</h3></div>
                <div class="metric-content"><p>Total de visitas:</p><strong id="mesVisitas">0</strong></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#6366f1;"><i class="fas fa-user-friends"></i></div><h3>Indicações Empresa</h3></div>
                <div class="metric-content"><p>Total de indicações:</p><strong id="mesIndicacoes">0</strong></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#f59e0b;"><i class="fas fa-reply"></i></div><h3>Retornos</h3></div>
                <div class="metric-content"><p>Retornos no mês:</p><strong id="mesRetornos">0</strong></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#10b981;"><i class="fas fa-chart-line"></i></div><h3>TOTAL</h3></div>
                <div class="metric-content"><p>Atendimentos totais:</p><strong id="mesTotalGeral">0</strong></div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria - Mês</h4><div class="chart-container"><canvas id="chartDiretoriaMes"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento - Mês</h4><div class="chart-container"><canvas id="chartTipoAtendimentoMes"></canvas></div></div>
        </div>

        <h2 class="timeline-header">Performance do Mês por Diretoria</h2>
        <div class="timeline-container" id="timelineDiretoriaMes">
            <!-- conteúdo populado via JS -->
        </div>
    </div>

    <!-- HISTÓRICO MENSAL (mantido) -->
    <div id="historico-mes" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title"><i class="fas fa-history" style="color:#8b5cf6"></i> Histórico Mensal</h1>
            <p class="dashboard-subtitle">Relatórios mensais</p>
        </div>

        <div class="metrics-grid">
            <!-- cards mantidos -->
            <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-door-open"></i></div><h3>Visitas Espontâneas</h3></div><div class="metric-content"><strong id="histVisitas">0</strong></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-user-friends"></i></div><h3>Indicações</h3></div><div class="metric-content"><strong id="histIndicacoes">0</strong></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-reply"></i></div><h3>Retornos</h3></div><div class="metric-content"><strong id="histRetornos">0</strong></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-chart-line"></i></div><h3>Total</h3></div><div class="metric-content"><strong id="histTotal">0</strong></div></div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria - Histórico</h4><div class="chart-container"><canvas id="chartDiretoriaHistorico"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento - Histórico</h4><div class="chart-container"><canvas id="chartTipoAtendimentoHistorico"></canvas></div></div>
        </div>

    </div>

    <!-- PANORAMA ESTOQUE (mantido idêntico ao original) -->
    <div id="panorama-estoque" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title"><i class="fas fa-boxes" style="color:#8b5cf6"></i> Panorama Estoque</h1>
            <p class="dashboard-subtitle">Visão geral de vendas, estoque e performance - Camino</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header"><div class="icon"><i class="fas fa-bullseye"></i></div><h3>Performance Unidades</h3></div>
                <div class="metric-content"><p>Meta 2025: 28 unidades</p><strong>17 unidades</strong><p class="info-text">60.7% de atingimento</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon"><i class="fas fa-chart-line"></i></div><h3>Performance VGV</h3></div>
                <div class="metric-content"><p>Meta 2025: R$ 320M</p><strong>R$ 207.1M</strong><p class="info-text">64.7% de atingimento</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon"><i class="fas fa-calendar-check"></i></div><h3>Outubro 2025</h3></div>
                <div class="metric-content"><p>Meta: 5 unidades</p><strong>4 unidades</strong><p class="info-text">80% de atingimento</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon"><i class="fas fa-box"></i></div><h3>Estoque Total</h3></div>
                <div class="metric-content"><p>Unidades disponíveis:</p><strong>39 unidades</strong><p class="info-text">De 56 unidades totais</p></div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Vendas por Torre</h4><div class="chart-container"><canvas id="chartVendasTorre"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Origem das Vendas</h4><div class="chart-container"><canvas id="chartOrigemVendas"></canvas></div></div>
        </div>

        <div class="timeline-container">
            <div class="timeline-card">
                <h4><i class="fas fa-check-circle" style="color:#10b981"></i> UNIDADES VENDIDAS</h4>
                <h5>Total: 17 unidades</h5>
                <div class="list-group"><h5><i class="fas fa-building"></i> Por Torre</h5><ul><li>JARDINS: 5 unidades</li><li>EUROPA: 7 unidades</li><li>PARQUE: 5 unidades</li></ul></div>
                <div class="list-group"><h5><i class="fas fa-ruler-combined"></i> Por Metragem</h5><ul><li>387m²: 9 unidades</li><li>300m²: 7 unidades</li><li>Coberturas: 1 unidade</li></ul></div>
                <div class="list-group"><h5><i class="fas fa-tag"></i> Por Origem</h5><ul><li>ONLINE: 5 unidades</li><li>CARTEIRA: 4 unidades</li><li>VEZ: 2 unidades</li><li>DIRETORIA: 6 unidades</li></ul></div>
            </div>

            <div class="timeline-card">
                <h4><i class="fas fa-warehouse" style="color:#3b82f6"></i> ESTOQUE ATUAL</h4>
                <h5>Total: 56 unidades (39 disponíveis)</h5>
                <div class="list-group"><h5><i class="fas fa-building"></i> Torre Jardins</h5><ul><li>1 Garden</li><li>7 Tipos 387m²</li><li>1 Cobertura</li><li style="color:#10b981;font-weight:700">Vendidas: 5 unidades</li></ul></div>
                <div class="list-group"><h5><i class="fas fa-building"></i> Torre Parque</h5><ul><li>1 Garden</li><li>8 Tipos 387m²</li><li style="color:#10b981;font-weight:700">Vendidas: 5 unidades</li></ul></div>
                <div class="list-group"><h5><i class="fas fa-building"></i> Torre Europa</h5><ul><li>19 Tipos 300m²</li><li>2 Coberturas</li><li style="color:#10b981;font-weight:700">Vendidas: 7 unidades</li></ul></div>
            </div>

            <div class="timeline-card">
                <h4><i class="fas fa-trophy" style="color:#f59e0b"></i> PERFORMANCE 2025</h4>
                <div class="list-group"><h5><i class="fas fa-cube"></i> Unidades</h5><ul><li>Meta: 28 unidades</li><li>Realizado: 17 unidades</li><li style="color:#10b981;font-weight:700">Atingimento: 60.%</li></ul></div>
                <div class="list-group"><h5><i class="fas fa-money-bill-wave"></i> VGV</h5><ul><li>Meta: R$ 320.000.000</li><li>Realizado: R$ 207.158.088</li><li style="color:#3b82f6;font-weight:700">Atingimento: 64.7%</li></ul></div>
                <div class="list-group"><h5><i class="fas fa-calendar-alt"></i> Outubro/2025</h5><ul><li>Meta: 5 unidades</li><li>Realizado: 4 unidades</li><li style="color:#f59e0b;font-weight:700">Atingimento: 80%</li></ul></div>
            </div>
        </div>

    </div>

    <!-- CONTROLE ATENDIMENTOS -->
    <div id="controle-atendimentos" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title"><i class="fas fa-calendar-check" style="color:#3b82f6"></i> Controle de Atendimentos</h1>
            <p class="dashboard-subtitle">Gestão completa de visitas e atendimentos comerciais</p>
        </div>

        <div class="filter-container">
            <div class="date-range">
                <div class="filter-group">
                    <label for="filterDataInicio"><i class="fas fa-calendar"></i> Data Início</label>
                    <input type="date" id="filterDataInicio" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="filterDataFim"><i class="fas fa-calendar"></i> Data Fim</label>
                    <input type="date" id="filterDataFim" class="filter-input">
                </div>
            </div>
            <div class="filter-group">
                <label for="filterDiretoria"><i class="fas fa-building"></i> Diretoria</label>
                <select id="filterDiretoria" class="filter-select">
                    <option value="todas">Todas as Diretorias</option>
                    <option value="YUNY STORE">YUNY STORE</option>
                    <option value="PARCERIAS">PARCERIAS</option>
                    <option value="YUNY SELL">YUNY SELL</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterTipo"><i class="fas fa-tag"></i> Tipo de Visita</label>
                <select id="filterTipo" class="filter-select">
                    <option value="todos">Todos os Tipos</option>
                    <option value="VEZ">Vez</option>
                    <option value="INDICAÇÃO">Indicação</option>
                    <option value="RETORNO">Retorno</option>
                    <option value="LIGAÇÃO">Ligação</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Aplicar Filtros</button>
                <button class="btn btn-secondary" onclick="limparFiltros()"><i class="fas fa-undo"></i> Limpar</button>
                <button class="btn btn-success" onclick="exportarParaCSV()"><i class="fas fa-download"></i> Exportar CSV</button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header"><div class="icon"><i class="fas fa-calendar-check"></i></div><h3>TOTAL</h3></div>
                <div class="metric-content"><strong id="totalAtendimentos">0</strong><p class="info-text">No período selecionado</p></div>
            </div>
            <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-store-alt"></i></div><h3>YUNY STORE</h3></div><div class="metric-content"><strong id="totalStore">0</strong><p class="info-text">Atendimentos da Store</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-handshake"></i></div><h3>PARCERIAS</h3></div><div class="metric-content"><strong id="totalParcerias">0</strong><p class="info-text">Atendimentos Parcerias</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-chart-line"></i></div><h3>YUNY SELL</h3></div><div class="metric-content"><strong id="totalYunySell">0</strong><p class="info-text">Atendimentos Yuny Sell</p></div></div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Atendimentos por Diretoria</h4><div class="chart-container"><canvas id="chartDiretoriaAtendimentos"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Atendimentos por Tipo</h4><div class="chart-container"><canvas id="chartTipoAtendimentos"></canvas></div></div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Registro de Atendimentos</h3>
                <div class="table-actions">
                    <input type="text" id="searchInput" class="search-box" placeholder="Buscar..." onkeyup="filtrarTabela()">
                    <button class="btn btn-secondary" onclick="limparBusca()"><i class="fas fa-times"></i> Limpar</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="atendimentos-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo de Visita</th>
                            <th>Corretor</th>
                            <th>Gerente</th>
                            <th>Mídia</th>
                            <th>Empresa</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaAtendimentos">
                        <tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados da planilha...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="paginationInfo">Mostrando 0 de 0 registros</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="mudarPagina(-1)" disabled id="btnPrev"><i class="fas fa-chevron-left"></i> Anterior</button>
                    <button class="pagination-btn" onclick="mudarPagina(1)" id="btnNext">Próxima <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- PIPELINE -->
    <div id="tratativas" class="dashboard">
        <div class="header-pipeline">
            <h1 class="dashboard-title"><i class="fas fa-filter" style="color:#3b82f6"></i> Pipeline de Tratativas</h1>
            <p class="dashboard-subtitle">Visão detalhada do funil de vendas</p>
            <div id="pipelineStatusArea" style="margin-top:10px;font-size:.9em"></div>
        </div>

        <div class="pipeline-container" id="pipelineRoot">
            <!-- colunas populadas via JS -->
        </div>
    </div>

</div>

<script>
/* ============================
   CONFIGURAÇÕES (só alteradas conforme solicitado)
   ============================ */
const SHEET_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE4TL2UpdsZM43opfqqdDH2gdW_tzoHd4z-_7vxb6koicdOJWt6r-SoFVR0FWaAEs8UmJJGirQ0h0S/pub?gid=0&single=true&output=csv';
const PIPELINE_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdqDsD7zwfjYT3BkEpLe_qBUPXjmPkOhkbJTM-VbGF71l94gijdOLIgQz9CkebfjnSobOPvZalst51/pub?gid=0&single=true&output=csv';

const DIRETORIAS = ['YUNY STORE','PARCERIAS','YUNY SELL'];
const CORES = { 'YUNY STORE':'#6366f1', 'PARCERIAS':'#f59e0b', 'YUNY SELL':'#06b6d4' };

/* ============================
   Helpers: atualização de elementos (suporta múltiplos ids repetidos no DOM)
   ============================ */
function setTextAll(id, text){
    // seleciona por atributo id (p/ casos onde o id se repete)
    const nodes = document.querySelectorAll(`[id="${id}"]`);
    if(nodes && nodes.length){
        nodes.forEach(n => { n.textContent = text; });
    } else {
        const single = document.getElementById(id);
        if(single) single.textContent = text;
    }
}

/* ============================
   CSV parser robusto (detecta delimitador e suporta aspas)
   ============================ */
function detectDelimiter(headerLine){
    if(!headerLine) return ',';
    if(headerLine.indexOf(';') !== -1 && headerLine.indexOf(',') === -1) return ';';
    if(headerLine.indexOf('\t') !== -1 && headerLine.indexOf(',') === -1) return '\t';
    // default
    return ',';
}

function splitCSVLine(line, delimiter){
    const res = [];
    let cur = '';
    let inQuotes = false;
    for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){
            if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
            inQuotes = !inQuotes;
            continue;
        }
        if(ch === delimiter && !inQuotes){
            res.push(cur);
            cur = '';
            continue;
        }
        cur += ch;
    }
    res.push(cur);
    return res.map(s => s.trim());
}

function csvToJson(csv){
    if(!csv) return { data:[], headers:[] };
    const normalized = csv.replace(/\r/g,'').split('\n').filter(l => l.trim() !== '');
    if(normalized.length === 0) return { data:[], headers:[] };
    const delimiter = detectDelimiter(normalized[0]);
    const rawHeaders = splitCSVLine(normalized[0], delimiter).map(h => h.replace(/^"|"$/g,'').trim());
    const data = [];
    for(let i=1;i<normalized.length;i++){
        const row = splitCSVLine(normalized[i], delimiter);
        if(row.length === 1 && row[0] === '') continue;
        const obj = {};
        for(let j=0;j<rawHeaders.length;j++){
            obj[rawHeaders[j] || `COL${j}`] = (row[j] || '').replace(/^"|"$/g,'').trim();
        }
        data.push(obj);
    }
    return { data, headers: rawHeaders };
}

/* ============================
   Funções utilitárias de data e currency
   ============================ */
function parseDateBR(d){
    if(!d) return null;
    // formatos esperados: DD/MM/YYYY ou YYYY-MM-DD
    if(d.indexOf('/') !== -1){
        const parts = d.split('/');
        if(parts.length === 3) return new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00`);
    }
    if(d.indexOf('-') !== -1){
        return new Date(d + 'T00:00:00');
    }
    return null;
}
function formatCurrencyBR(v){
    if(isNaN(v)) return 'R$ 0';
    return Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
}

/* ============================
   Carregar dados de ATENDIMENTOS (SHEET_DATA_URL)
   ============================ */
let atendimentosData = [];
let atendimentosFiltrados = [];
let paginaAtual = 1;
const itensPorPagina = 10;

async function carregarDadosAtendimentos(){
    const tabelaBody = document.getElementById('tabelaAtendimentos');
    const statusArea = document.getElementById('statusArea');
    if(tabelaBody) tabelaBody.innerHTML = `<tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados da planilha...</td></tr>`;
    try{
        const res = await fetch(SHEET_DATA_URL);
        if(!res.ok) throw new Error(`Erro ao buscar planilha (status ${res.status})`);
        const csv = await res.text();
        const { data, headers } = csvToJson(csv);
        atendimentosData = data;
        // Identificar coluna Empresa (heurística)
        const headerMap = {};
        headers.forEach(h => headerMap[h.toUpperCase()] = h);
        let colEmpresa = headerMap['EMPRESA'] || headerMap['EMPRESA/EMPRESA'] || headerMap['EMPRESA NOME'] || headerMap['COMPANY'] || headerMap['EMPRESA'] || null;
        if(!colEmpresa){
            // fallback: tenta achar coluna 'Empresa' por substring
            for(const h of headers){
                if(h.toUpperCase().includes('EMP') || h.toUpperCase().includes('COMPANY') || h.toUpperCase().includes('EMPRESA')){ colEmpresa = h; break; }
            }
        }
        // preencher cards por diretoria
        const counts = {};
        DIRETORIAS.forEach(d => counts[d] = 0);
        // métricas gerais
        let totalSemana = 0, visitas =0, indicacoes=0, retornos=0, propostas=0;
        data.forEach(row => {
            const empresaRaw = (colEmpresa && row[colEmpresa]) ? row[colEmpresa].toUpperCase() : '';
            // checar tipos
            const tipoRaw = Object.values(row).join(' ').toUpperCase(); // fallback mais genérico se não houver coluna TIPO
            if(tipoRaw.includes('VEZ')) visitas++;
            if(tipoRaw.includes('INDI')) indicacoes++;
            if(tipoRaw.includes('RETORNO')) retornos++;
            if(tipoRaw.includes('PROPOSTA')) propostas++;
            // contar por diretoria
            DIRETORIAS.forEach(dir => {
                // aceitar variações (com e sem espaço)
                if(empresaRaw.includes(dir) || empresaRaw.includes(dir.replace(' ','').toUpperCase()) || empresaRaw.includes(dir.split(' ')[0])){
                    counts[dir] = (counts[dir] || 0) + 1;
                }
            });
        });
        totalSemana = data.length;
        // Atualizar elementos (suporta ids repetidos)
        setTextAll('totalAtendimentosSemana', totalSemana.toLocaleString('pt-BR'));
        setTextAll('resumoVisitas', visitas.toLocaleString('pt-BR'));
        setTextAll('resumoIndicacoes', indicacoes.toLocaleString('pt-BR'));
        setTextAll('resumoRetornos', retornos.toLocaleString('pt-BR'));
        setTextAll('resumoPropostas', propostas.toLocaleString('pt-BR'));
        // atualizar cards controle atendimentos
        setTextAll('totalStore', (counts['YUNY STORE']||0).toLocaleString('pt-BR'));
        setTextAll('totalParcerias', (counts['PARCERIAS']||0).toLocaleString('pt-BR'));
        setTextAll('totalYunySell', (counts['YUNY SELL']||0).toLocaleString('pt-BR'));
        // atualizar cards de resumo (aba principal)
        setTextAll('totalStore', (counts['YUNY STORE']||0).toLocaleString('pt-BR'));
        setTextAll('totalParcerias', (counts['PARCERIAS']||0).toLocaleString('pt-BR'));
        setTextAll('totalSell', (counts['YUNY SELL']||0).toLocaleString('pt-BR'));
        // popular tabela completa (controle de atendimentos)
        atendimentosFiltrados = data.slice();
        paginaAtual = 1;
        renderizarTabela();
        // Gráficos (Chart.js) - Diretoria (sem home/diretoria extras)
        const diretoriaLabels = ['Yuny Store','Parcerias','Yuny Sell'];
        const diretoriaData = [counts['YUNY STORE']||0, counts['PARCERIAS']||0, counts['YUNY SELL']||0];
        // diretoria semana chart
        const ctxD = document.getElementById('chartDiretoriaSemana').getContext('2d');
        if(window._chartDiretoriaSemana) window._chartDiretoriaSemana.destroy();
        window._chartDiretoriaSemana = new Chart(ctxD, {
            type:'pie',
            data:{
                labels: diretoriaLabels,
                datasets:[{ data: diretoriaData, backgroundColor: [CORES['YUNY STORE'], CORES['PARCERIAS'], CORES['YUNY SELL']] }]
            },
            options:{responsive:true}
        });
        // tipo atendimento chart (simplificado: contar ocorrências de strings)
        const tiposCount = { 'VEZ':0, 'INDICAÇÃO':0, 'RETORNO':0, 'PROPOSTA':0, 'OUTROS':0 };
        data.forEach(r => {
            const t = Object.values(r).join(' ').toUpperCase();
            if(t.includes('VEZ')) tiposCount['VEZ']++;
            else if(t.includes('INDI')) tiposCount['INDICAÇÃO']++;
            else if(t.includes('RETORNO')) tiposCount['RETORNO']++;
            else if(t.includes('PROPOSTA')) tiposCount['PROPOSTA']++;
            else tiposCount['OUTROS']++;
        });
        const ctxT = document.getElementById('chartTipoAtendimento').getContext('2d');
        if(window._chartTipoAtendimento) window._chartTipoAtendimento.destroy();
        window._chartTipoAtendimento = new Chart(ctxT, {
            type:'bar',
            data:{
                labels:Object.keys(tiposCount),
                datasets:[{ label:'Atendimentos', data:Object.values(tiposCount) }]
            },
            options:{responsive:true}
        });

    } catch(err){
        console.error('Erro carregarAtendimentos:', err);
        const tabelaBody = document.getElementById('tabelaAtendimentos');
        if(tabelaBody) tabelaBody.innerHTML = `<tr><td colspan="6" class="error-message">Erro ao carregar dados: ${err.message}</td></tr>`;
    }
}

/* ============================
   Render tabela com paginação, busca e filtros
   ============================ */
function aplicarFiltros(){
    const dataInicio = document.getElementById('filterDataInicio').value;
    const dataFim = document.getElementById('filterDataFim').value;
    const diretoria = document.getElementById('filterDiretoria').value;
    const tipo = document.getElementById('filterTipo').value;
    // filtra atendimentosData
    let arr = atendimentosData.slice();
    // detectar colunas possíveis
    function findKeyLike(keys){ for(const k of keys){ for(const h of Object.keys(arr[0]||{})){ if(h.toUpperCase().includes(k)) return h; } } return null; }
    const keyData = findKeyLike(['DATA','DATE']);
    const keyTipo = findKeyLike(['TIPO','TYPE']);
    const keyEmpresa = findKeyLike(['EMPRESA','COMPANY','EMPRESA']);
    if(dataInicio){
        const dtInicio = parseDateBR(dataInicio);
        arr = arr.filter(r => {
            const d = parseDateBR(r[keyData] || r['Data'] || '');
            return d && d >= dtInicio;
        });
    }
    if(dataFim){
        const dtFim = parseDateBR(dataFim);
        arr = arr.filter(r => {
            const d = parseDateBR(r[keyData] || r['Data'] || '');
            return d && d <= dtFim;
        });
    }
    if(diretoria && diretoria !== 'todas'){
        arr = arr.filter(r => {
            const emp = (r[keyEmpresa] || '').toUpperCase();
            return emp.includes(diretoria);
        });
    }
    if(tipo && tipo !== 'todos'){
        arr = arr.filter(r => {
            const t = (r[keyTipo] || Object.values(r).join(' ')).toUpperCase();
            return t.includes(tipo.toUpperCase());
        });
    }
    atendimentosFiltrados = arr;
    paginaAtual = 1;
    renderizarTabela();
}

function limparFiltros(){
    document.getElementById('filterDataInicio').value = '';
    document.getElementById('filterDataFim').value = '';
    document.getElementById('filterDiretoria').value = 'todas';
    document.getElementById('filterTipo').value = 'todos';
    atendimentosFiltrados = atendimentosData.slice();
    paginaAtual = 1;
    renderizarTabela();
}

function filtrarTabela(){
    const q = document.getElementById('searchInput').value.toLowerCase();
    if(!q){ atendimentosFiltrados = atendimentosData.slice(); renderizarTabela(); return; }
    atendimentosFiltrados = atendimentosData.filter(r => JSON.stringify(Object.values(r)).toLowerCase().includes(q));
    paginaAtual = 1;
    renderizarTabela();
}

function limparBusca(){ document.getElementById('searchInput').value=''; atendimentosFiltrados = atendimentosData.slice(); renderizarTabela(); }

function mudarPagina(delta){
    const totalPaginas = Math.ceil((atendimentosFiltrados.length||0)/itensPorPagina) || 1;
    paginaAtual = Math.min(Math.max(1, paginaAtual + delta), totalPaginas);
    renderizarTabela();
}

function renderizarTabela(){
    const tbody = document.getElementById('tabelaAtendimentos');
    if(!tbody) return;
    tbody.innerHTML = '';
    const total = atendimentosFiltrados.length || 0;
    const start = (paginaAtual-1)*itensPorPagina;
    const page = atendimentosFiltrados.slice(start, start+itensPorPagina);
    if(page.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="loading">Nenhum registro encontrado</td></tr>`;
    } else {
        page.forEach(r => {
            // tenta mapear colunas comuns
            const keys = Object.keys(r);
            const dataVal = r[keys.find(k=>k.toUpperCase().includes('DATA'))] || r[keys[0]] || '';
            const tipoVal = r[keys.find(k=>k.toUpperCase().includes('TIPO'))] || '';
            const corretorVal = r[keys.find(k=>k.toUpperCase().includes('CORRETOR'))] || '';
            const gerenteVal = r[keys.find(k=>k.toUpperCase().includes('GERENTE'))] || '';
            const midiaVal = r[keys.find(k=>k.toUpperCase().includes('MIDIA'))] || '';
            const empresaVal = r[keys.find(k=>k.toUpperCase().includes('EMP'))] || '';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${dataVal}</td><td>${tipoVal}</td><td>${corretorVal}</td><td>${gerenteVal}</td><td>${midiaVal}</td><td>${empresaVal}</td>`;
            tbody.appendChild(tr);
        });
    }
    // atualizar paginação info
    const paginationInfo = document.getElementById('paginationInfo');
    const totalPaginas = Math.ceil(total/itensPorPagina) || 1;
    if(paginationInfo) paginationInfo.textContent = `Mostrando ${Math.min(total, (paginaAtual*itensPorPagina))} de ${total} registros (página ${paginaAtual} de ${totalPaginas})`;
    document.getElementById('btnPrev').disabled = paginaAtual <= 1;
    document.getElementById('btnNext').disabled = paginaAtual >= totalPaginas;
    // também atualizar totais de cards
    setTextAll('totalAtendimentos', total.toLocaleString('pt-BR'));
}

/* ============================
   Export CSV (filtro atual)
   ============================ */
function exportarParaCSV(){
    if(!atendimentosFiltrados || atendimentosFiltrados.length === 0){ alert('Nenhum dado para exportar'); return; }
    const keys = Object.keys(atendimentosFiltrados[0]);
    const lines = [];
    lines.push(keys.join(','));
    atendimentosFiltrados.forEach(r => {
        const row = keys.map(k => `"${(r[k]||'').replace(/"/g,'""')}"`);
        lines.push(row.join(','));
    });
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'atendimentos_export.csv'; document.body.appendChild(a); a.click(); a.remove();
}

/* ============================
   CARREGAR PIPELINE (PIPELINE_DATA_URL)
   ============================ */
async function carregarPipeline(){
    const root = document.getElementById('pipelineRoot');
    root.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando pipeline...</div>`;
    try{
        const res = await fetch(PIPELINE_DATA_URL);
        if(!res.ok) throw new Error(`Erro ao buscar pipeline (status ${res.status})`);
        const csv = await res.text();
        const { data, headers } = csvToJson(csv);
        // Limpar root e criar colunas (apenas as 3 diretorias)
        root.innerHTML = '';
        const pipelineContainer = document.createElement('div');
        pipelineContainer.className = 'pipeline-container';
        DIRETORIAS.forEach(dir => {
            const col = document.createElement('div');
            col.className = 'pipeline-col';
            col.innerHTML = `<div class="col-header"><h3>${dir}</h3><div class="count">Total: <span class="count-value">0</span></div><div class="vgv-total" style="margin-top:6px;color:var(--success)">VGV: <span class="vgv-value">R$ 0</span></div></div><div class="col-content" data-dir="${dir}"></div>`;
            pipelineContainer.appendChild(col);
        });
        root.appendChild(pipelineContainer);
        // mapear colunas possíveis
        const headerMap = {};
        headers.forEach(h => headerMap[h.toUpperCase()] = h);
        const colEmpresa = headerMap['EMPRESA'] || headerMap['COMPANY'] || headers.find(h=>h.toUpperCase().includes('EMP'));
        const colUnidade = headerMap['UNIDADE'] || headerMap['UNIT'] || headers.find(h=>h.toUpperCase().includes('UNIDADE'));
        const colStatus = headerMap['STATUS'] || headerMap['STAGE'] || headers.find(h=>h.toUpperCase().includes('STATUS')||h.toUpperCase().includes('SITUACAO'));
        const colVgv = headerMap['VGV'] || headerMap['VALOR'] || headers.find(h=>h.toUpperCase().includes('VGV')||h.toUpperCase().includes('VALOR'));
        const colTooltip = headerMap['TOOLTIP'] || headerMap['OBS'] || headers.find(h=>h.toUpperCase().includes('OBS')||h.toUpperCase().includes('TOOLTIP'));
        // preencher itens
        const vgvSums = {}; const counts = {};
        DIRETORIAS.forEach(d=>{ vgvSums[d]=0; counts[d]=0; });
        data.forEach(row => {
            const empresaRaw = (colEmpresa && row[colEmpresa]) ? row[colEmpresa].toUpperCase() : '';
            const unidade = colUnidade ? (row[colUnidade] || '') : (row['UNIDADE']||'') ;
            const status = colStatus ? (row[colStatus] || '') : '';
            const vgvRaw = colVgv ? (row[colVgv]||'') : '';
            const tooltip = colTooltip ? (row[colTooltip]||'') : '';
            let vgv = 0;
            if(vgvRaw){
                const cleaned = vgvRaw.replace(/[^\d\-,\.]/g,'').replace(',','.');
                vgv = Number(cleaned) || 0;
            }
            DIRETORIAS.forEach(dir => {
                if(empresaRaw.includes(dir) || empresaRaw.includes(dir.replace(' ','').toUpperCase()) || empresaRaw.includes(dir.split(' ')[0])){
                    counts[dir]++; vgvSums[dir] += vgv;
                    // localizar coluna no DOM
                    const colContent = root.querySelector(`.col-content[data-dir="${dir}"]`);
                    if(colContent){
                        const linha = document.createElement('div');
                        linha.className = 'tratativa-row';
                        linha.innerHTML = `<div style="font-weight:600">${unidade || '—'}</div><div style="font-size:.9rem;color:var(--gray)">${status||''}</div>`;
                        if(tooltip) linha.title = tooltip;
                        colContent.appendChild(linha);
                    }
                }
            });
        });
        // atualizar totais e VGVs
        pipelineContainer.querySelectorAll('.pipeline-col').forEach(col => {
            const dir = col.querySelector('.col-content').dataset.dir;
            const totalElem = col.querySelector('.count-value');
            const vgvElem = col.querySelector('.vgv-value');
            if(totalElem) totalElem.textContent = (counts[dir]||0);
            if(vgvElem) vgvElem.textContent = (vgvSums[dir] && vgvSums[dir] > 0) ? formatCurrencyBR(vgvSums[dir]) : 'R$ 0';
        });
    } catch(err){
        console.error('Erro carregarPipeline:', err);
        const root = document.getElementById('pipelineRoot');
        if(root) root.innerHTML = `<div class="error-message">Erro ao carregar pipeline: ${err.message}</div>`;
    }
}

/* ============================
   Performance por Diretoria (Timeline) - mesmo comportamento do original mas só com 3 diret
   ============================ */
function atualizarPerformanceDiretoriaSemana(dadosResumo){
    const container = document.getElementById('timelineDiretoriaSemana');
    container.innerHTML = '';
    if(!dadosResumo || dadosResumo.length === 0){
        container.innerHTML = '<div class="warning-message">Nenhum dado encontrado para o período selecionado.</div>';
        return;
    }
    const metricas = {};
    DIRETORIAS.forEach(d => metricas[d] = { visitas:0, indicacoes:0, retornos:0, total:0 });
    // detectar colunas
    const headerKeys = Object.keys(dadosResumo[0]||{});
    const keyTipo = headerKeys.find(k=>k.toUpperCase().includes('TIPO')) || headerKeys[1] || null;
    const keyEmpresa = headerKeys.find(k=>k.toUpperCase().includes('EMP')) || headerKeys[4] || null;
    dadosResumo.forEach(item => {
        const tipo = (keyTipo && item[keyTipo]) ? item[keyTipo].toUpperCase() : (Object.values(item).join(' ').toUpperCase());
        const dirField = (keyEmpresa && item[keyEmpresa]) ? item[keyEmpresa].toUpperCase() : '';
        DIRETORIAS.forEach(d => {
            if(dirField.includes(d) || dirField.includes(d.replace(' ','').toUpperCase())){
                if(tipo.includes('VEZ')) metricas[d].visitas++;
                else if(tipo.includes('INDI')) metricas[d].indicacoes++;
                else if(tipo.includes('RETORNO')) metricas[d].retornos++;
                metricas[d].total = metricas[d].visitas + metricas[d].indicacoes + metricas[d].retornos;
            }
        });
    });
    DIRETORIAS.forEach(d => {
        const data = metricas[d];
        const card = document.createElement('div'); card.className = 'timeline-card';
        card.innerHTML = `<h4><i class="fas fa-circle" style="color:${CORES[d]}"></i> ${d}</h4><h5>Performance do Período</h5><ul><li>Visitas: ${data.visitas}</li><li>Indicações: ${data.indicacoes}</li><li>Retornos: ${data.retornos}</li><li>Total: ${data.total}</li></ul>`;
        container.appendChild(card);
    });
}

/* ============================
   Funções auxiliares de filtro do resumo (semana)
   ============================ */
function aplicarFiltroResumo(){
    // vai filtrar atendimentosData com base em resumoDataInicio / fim e então atualizar timeline e charts
    const inicio = document.getElementById('resumoDataInicio').value;
    const fim = document.getElementById('resumoDataFim').value;
    // se não houver dados carregados, chama carregarDadosAtendimentos
    if(!atendimentosData || atendimentosData.length === 0){ carregarDadosAtendimentos().then(()=> aplicarFiltroResumo()); return; }
    let arr = atendimentosData.slice();
    const keyData = Object.keys(arr[0]||{}).find(k=>k.toUpperCase().includes('DATA')) || null;
    if(inicio){
        const dtInicio = parseDateBR(inicio);
        arr = arr.filter(r => { const d = parseDateBR(r[keyData]||r['Data']||''); return d && d >= dtInicio; });
    }
    if(fim){
        const dtFim = parseDateBR(fim);
        arr = arr.filter(r => { const d = parseDateBR(r[keyData]||r['Data']||''); return d && d <= dtFim; });
    }
    // atualizar métricas resumidas usando arr
    atualizarPerformanceDiretoriaSemana(arr);
}

/* ============================
   Ajuda: definir semana atual (botão)
   ============================ */
function definirSemanaAtual(){
    const hoje = new Date();
    const dia = new Date(hoje);
    const inicio = new Date(dia.setDate(hoje.getDate() - 7));
    document.getElementById('resumoDataInicio').value = inicio.toISOString().slice(0,10);
    document.getElementById('resumoDataFim').value = hoje.toISOString().slice(0,10);
    aplicarFiltroResumo();
}

/* ============================
   Inicialização: carregar tudo
   ============================ */
document.addEventListener('DOMContentLoaded', ()=> {
    // tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', ()=> {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.dashboard').forEach(d=>d.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.dataset.target;
            const el = document.getElementById(target);
            if(el) el.classList.add('active');
        });
    });
    // carrega dados iniciais
    carregarDadosAtendimentos();
    carregarPipeline();
    // também popular gráficos do mês/histórico com placeholders (serão recalculados quando necessário)
});

/* ============================
   Expondo algumas funções no window para debug/interação via console
   ============================ */
window.carregarDadosAtendimentos = carregarDadosAtendimentos;
window.carregarPipeline = carregarPipeline;
window.aplicarFiltros = aplicarFiltros;
window.limparFiltros = limparFiltros;
window.exportarParaCSV = exportarParaCSV;
window.aplicarFiltroResumo = aplicarFiltroResumo;
window.definirSemanaAtual = definirSemanaAtual;
</script>
</body>
</html>
