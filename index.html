<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Camino</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f3f4f6; margin: 0; padding: 0; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 10px; flex-wrap: wrap; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 22px; font-weight: 700; color: #2563eb; }
    .logo img { height: 40px; border-radius: 8px; }
    .tabs { display: flex; gap: 10px; flex-wrap: wrap; }
    .tab { padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: 500; }
    .tab.active { background: #2563eb; color: #fff; border-color: #2563eb; }
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .dashboard-title { font-size: 26px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .metric-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .metric-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .metric-header .icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #f3f4f6; font-size: 1.2rem; }
    .chart-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .timeline-container { display: flex; overflow-x: auto; gap: 20px; margin-bottom: 30px; }
    .timeline-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); width: 280px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="https://caminoaltodaboavista.touchapp.com.br/img/logo.png" alt="Logo Camino">
        <span>Dashboard Camino</span>
      </div>
      <div class="tabs">
        <div class="tab active" data-target="resumo">Resumo da Semana</div>
        <div class="tab" data-target="panorama-estoque">Panorama Estoque</div>
        <div class="tab" data-target="controle-atendimentos">Controle de Atendimentos</div>
        <div class="tab" data-target="tratativas">Pipeline de Tratativas</div>
      </div>
    </header>

    <div id="resumo" class="dashboard active">
      <h1 class="dashboard-title"><i class="fas fa-calendar-week" style="color:#2563eb"></i> Resumo da Semana</h1>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header"><div class="icon"><i class="fas fa-store"></i></div><h3>YUNY STORE</h3></div>
          <strong id="totalStore">0</strong>
          <p>Atendimentos da semana</p>
        </div>
        <div class="metric-card">
          <div class="metric-header"><div class="icon"><i class="fas fa-handshake"></i></div><h3>PARCERIAS</h3></div>
          <strong id="totalParcerias">0</strong>
          <p>Atendimentos da semana</p>
        </div>
        <div class="metric-card">
          <div class="metric-header"><div class="icon"><i class="fas fa-chart-line"></i></div><h3>YUNY SELL</h3></div>
          <strong id="totalSell">0</strong>
          <p>Atendimentos da semana</p>
        </div>
      </div>
      <div class="chart-card">
        <h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria</h4>
        <canvas id="chartDiretoriaSemana"></canvas>
      </div>
    </div>

    <div id="panorama-estoque" class="dashboard">
      <div class="dashboard-header">
        <h1 class="dashboard-title">
          <i class="fas fa-boxes" style="color: #8b5cf6;"></i>
          Panorama Estoque
        </h1>
        <p class="dashboard-subtitle">Visão geral de vendas, estoque e performance - Camino</p>
      </div>

      <div class="metrics-grid">

          <div class="metric-card">
              <div class="metric-header">
                  <div class="icon" style="color: #10b981;"><i class="fas fa-bullseye"></i></div>
                  <h3>Performance Unidades</h3>
              </div>
              <div class="metric-content">
                  <p>Meta 2025: 28 unidades</p>
                  <strong>17 unidades</strong>
                  <p class="info-text">60.7% de atingimento</p>
              </div>
          </div>
          <div class="metric-card">
              <div class="metric-header">
                  <div class="icon" style="color: #3b82f6;"><i class="fas fa-chart-line"></i></div>
                  <h3>Performance VGV</h3>
              </div>
              <div class="metric-content">
                  <p>Meta 2025: R$ 320M</p>
                  <strong>R$ 207.1M</strong>
                  <p class="info-text">64.7% de atingimento</p>
              </div>
          </div>
          <div class="metric-card">
              <div class="metric-header">
                  <div class="icon" style="color: #f59e0b;"><i class="fas fa-calendar-check"></i></div>
                  <h3>Outubro 2025</h3>
              </div>
              <div class="metric-content">
                  <p>Meta: 5 unidades</p>
                  <strong>4 unidades</strong>
                  <p class="info-text">80% de atingimento</p>
              </div>
          </div>
          <div class="metric-card">
              <div class="metric-header">
                  <div class="icon" style="color: #ef4444;"><i class="fas fa-box"></i></div>
                  <h3>Estoque Total</h3>
              </div>
              <div class="metric-content">
                  <p>Unidades disponíveis:</p>
                  <strong>39 unidades</strong>
                  <p class="info-text">De 56 unidades totais</p>
              </div>
          </div>
      </div>

      <div class="charts-container">
          <div class="chart-card">
              <h4><i class="fas fa-chart-pie"></i> Vendas por Torre</h4>
              <div class="chart-container">
                  <canvas id="chartVendasTorre"></canvas>
              </div>
          </div>
          <div class="chart-card">
              <h4><i class="fas fa-chart-bar"></i> Origem das Vendas</h4>
              <div class="chart-container">
                  <canvas id="chartOrigemVendas"></canvas>
              </div>
          </div>
      </div>

      <div class="timeline-container">
          <div class="timeline-card">
              <h4><i class="fas fa-check-circle" style="color: #10b981;"></i> UNIDADES VENDIDAS</h4>
              <h5>Total: 17 unidades</h5>
              
              <div class="list-group">
                  <h5><i class="fas fa-building"></i> Por Torre</h5>
                  <ul>
                      <li>JARDINS: 5 unidades</li>
                      <li>EUROPA: 7 unidades</li>
                      <li>PARQUE: 5 unidades</li>
                  </ul>
              </div>
              
              <div class="list-group">
                  <h5><i class="fas fa-ruler-combined"></i> Por Metragem</h5>
                  <ul>
                      <li>387m²: 9 unidades</li>
                      <li>300m²: 7 unidades</li>
                      <li>Coberturas: 1 unidade</li>
                  </ul>
              </div>

              <div class="list-group">
                  <h5><i class="fas fa-tag"></i> Por Origem</h5>
                  <ul>
                      <li>ONLINE: 5 unidades</li>
                      <li>CARTEIRA: 4 unidades</li>
                      <li>VEZ: 2 unidades</li>
                      <li>DIRETORIA: 6 unidades</li>
                  </ul>
              </div>
          </div>

          <div class="timeline-card">
              <h4><i class="fas fa-warehouse" style="color: #3b82f6;"></i> ESTOQUE ATUAL</h4>
              <h5>Total: 56 unidades (39 disponíveis)</h5>
              
              <div class="list-group">
                  <h5><i class="fas fa-building"></i> Torre Jardins</h5>
                  <ul>
                      <li>1 Garden</li>
                      <li>7 Tipos 387m²</li>
                      <li>1 Cobertura</li>
                      <li style="color: #10b981; font-weight: bold;">Vendidas: 5 unidades</li>
                  </ul>
              </div>
              
              <div class="list-group">
                  <h5><i class="fas fa-building"></i> Torre Parque</h5>
                  <ul>
                      <li>1 Garden</li>
                      <li>8 Tipos 387m²</li>
                      <li style="color: #10b981; font-weight: bold;">Vendidas: 5 unidades</li>
                  </ul>
              </div>

              <div class="list-group">
                  <h5><i class="fas fa-building"></i> Torre Europa</h5>
                  <ul>
                      <li>19 Tipos 300m²</li>
                      <li>2 Coberturas</li>
                      <li style="color: #10b981; font-weight: bold;">Vendidas: 7 unidades</li>
                  </ul>
              </div>
          </div>

          <div class="timeline-card">
              <h4><i class="fas fa-trophy" style="color: #f59e0b;"></i> PERFORMANCE 2025</h4>
              
              <div class="list-group">
                  <h5><i class="fas fa-cube"></i> Unidades</h5>
                  <ul>
                      <li>Meta: 28 unidades</li>
                      <li>Realizado: 17 unidades</li>
                      <li style="color: #10b981; font-weight: bold;">Atingimento: 60.%</li>
                  </ul>
              </div>
              
              <div class="list-group">
                  <h5><i class="fas fa-money-bill-wave"></i> VGV</h5>
                  <ul>
                      <li>Meta: R$ 320.000.000</li>
                      <li>Realizado: R$ 207.158.088</li>
                      <li style="color: #3b82f6; font-weight: bold;">Atingimento: 64.7%</li>
                  </ul>
              </div>
              
              <div class="list-group">
                  <h5><i class="fas fa-calendar-alt"></i> Outubro/2025</h5>
                  <ul>
                      <li>Meta: 5 unidades</li>
                      <li>Realizado: 4 unidades</li>
                      <li style="color: #f59e0b; font-weight: bold;">Atingimento: 80%</li>
                  </ul>
              </div>
          </div>
      </div>

      <div class="charts-container">
          <div class="chart-card">
              <h4><i class="fas fa-chart-line"></i> Performance de Atingimento</h4>
              <div class="chart-container">
                  <canvas id="chartPerformance"></canvas>
              </div>
          </div>
          <div class="chart-card">
              <h4><i class="fas fa-balance-scale"></i> Vendas vs Estoque</h4>
              <div class="chart-container">
                  <canvas id="chartVendasEstoque"></canvas>
              </div>
          </div>
      </div>

    <div id="controle-atendimentos" class="dashboard">
      <h1 class="dashboard-title"><i class="fas fa-calendar-check" style="color:#3b82f6"></i> Controle de Atendimentos</h1>
      <div class="metrics-grid">
        <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-store"></i></div><h3>YUNY STORE</h3></div><strong id="contStore">0</strong></div>
        <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-handshake"></i></div><h3>PARCERIAS</h3></div><strong id="contParcerias">0</strong></div>
        <div class="metric-card"><div class="metric-header"><div class="icon"><i class="fas fa-chart-line"></i></div><h3>YUNY SELL</h3></div><strong id="contSell">0</strong></div>
      </div>
    </div>

    <div id="tratativas" class="dashboard">
      <h1 class="dashboard-title"><i class="fas fa-filter" style="color:#3b82f6"></i> Pipeline de Tratativas</h1>
      <p>Carregando dados do pipeline Camino...</p>
    </div>
  </div>

  <script>
    // --------------------- CONFIG ---------------------
    const SHEET_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE4TL2UpdsZM43opfqqdDH2gdW_tzoHd4z-_7vxb6koicdOJWt6r-SoFVR0FWaAEs8UmJJGirQ0h0S/pub?gid=0&single=true&output=csv';
    const PIPELINE_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdqDsD7zwfjYT3BkEpLe_qBUPXjmPkOhkbJTM-VbGF71l94gijdOLIgQz9CkebfjnSobOPvZalst51/pub?gid=0&single=true&output=csv';

    const diretorias = ['YUNY STORE', 'PARCERIAS', 'YUNY SELL'];
    const cores = { 'YUNY STORE':'#6366f1', 'PARCERIAS':'#f59e0b', 'YUNY SELL':'#06b6d4' };

    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => tab.addEventListener('click', () => {
      document.querySelector('.tab.active').classList.remove('active');
      document.querySelector('.dashboard.active').classList.remove('active');
      tab.classList.add('active');
      document.getElementById(tab.dataset.target).classList.add('active');
    }));

    // --------------------- CSV PARSER SIMPLES (suporta aspas) ---------------------
    function detectDelimiter(headerLine) {
      if (!headerLine) return ',';
      if (headerLine.includes(';') && !headerLine.includes(',;')) return ';';
      if (headerLine.includes('	')) return '	';
      return ',';
    }

    function splitCSVLine(line, delimiter) {
      const result = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          // If double-quote and next is quote, treat as escaped quote
          if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if (ch === delimiter && !inQuotes) { result.push(cur); cur = ''; continue; }
        cur += ch;
      }
      result.push(cur);
      return result.map(s => s.trim());
    }

    function csvToJson(csv) {
      if (!csv) return { data: [], headers: [] };
      const lines = csv.replace(/
/g, '').split('
').filter(l => l.trim() !== '');
      if (lines.length === 0) return { data: [], headers: [] };
      const delimiter = detectDelimiter(lines[0]);
      const rawHeaders = splitCSVLine(lines[0], delimiter).map(h => h.replace(/^"|"$/g, '').trim());
      const normalized = rawHeaders.map(h => h.toUpperCase());
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const row = splitCSVLine(lines[i], delimiter);
        if (row.length === 1 && row[0] === '') continue;
        const obj = {};
        for (let j = 0; j < normalized.length; j++) {
          obj[rawHeaders[j] || `COL${j}`] = (row[j] || '').replace(/^"|"$/g, '').trim();
        }
        data.push(obj);
      }
      return { data, headers: rawHeaders };
    }

    // --------------------- RESUMO / CONTROLE ---------------------
    async function carregarResumo() {
      try {
        const resp = await fetch(SHEET_DATA_URL);
        if (!resp.ok) throw new Error(`Falha ao buscar dados: ${resp.status}`);
        const csv = await resp.text();
        const { data, headers } = csvToJson(csv);

        // Busca chave que corresponde à coluna que contém a empresa
        const headerMap = headers.reduce((acc, h, i) => { acc[h.toUpperCase()] = h; return acc; }, {});
        // Procura pelas colunas mais prováveis
        const possibleEmpresa = ['EMPRESA','EMPRESA','COMPANY','COMPANY NAME','CONDOMINIO','EMPRESA'];
        let empresaKey = null;
        for (const k of Object.keys(headerMap)) {
          if (['EMPRESA','EMPRESA','COMPANY','COMPANY NAME','COMPANYNAME','EMPRESA'].includes(k)) { empresaKey = headerMap[k]; break; }
        }
        // fallback para a 5ª coluna se não encontrar
        if (!empresaKey && data.length && Object.keys(data[0])[4]) {
          empresaKey = Object.keys(data[0])[4];
        }

        const counts = { 'YUNY STORE':0, 'PARCERIAS':0, 'YUNY SELL':0 };

        data.forEach(row => {
          const raw = (empresaKey && row[empresaKey]) ? row[empresaKey].toUpperCase() : '';
          diretorias.forEach(dir => {
            if (raw.includes(dir.replace(' ', '')) || raw.includes(dir)) counts[dir]++;
          });
        });

        document.getElementById('totalStore').textContent = counts['YUNY STORE'];
        document.getElementById('totalParcerias').textContent = counts['PARCERIAS'];
        document.getElementById('totalSell').textContent = counts['YUNY SELL'];

        // Atualiza controle de atendimentos (mesmos ids)
        document.getElementById('contStore').textContent = counts['YUNY STORE'];
        document.getElementById('contParcerias').textContent = counts['PARCERIAS'];
        document.getElementById('contSell').textContent = counts['YUNY SELL'];

        // Gera gráfico de pizza
        const ctx = document.getElementById('chartDiretoriaSemana').getContext('2d');
        if (window._chartDiretoria) window._chartDiretoria.destroy();
        window._chartDiretoria = new Chart(ctx, { type:'pie', data:{ labels:['Yuny Store','Parcerias','Yuny Sell'], datasets:[{ data:[counts['YUNY STORE'], counts['PARCERIAS'], counts['YUNY SELL']], backgroundColor:[cores['YUNY STORE'], cores['PARCERIAS'], cores['YUNY SELL']] }] }, options:{ responsive:true } });

      } catch (err) {
        console.error('Erro carregarResumo:', err);
        const resumo = document.getElementById('resumo');
        resumo.insertAdjacentHTML('afterbegin', `<div class="error-message">Erro ao carregar dados da planilha: ${err.message}</div>`);
      }
    }

    // --------------------- PIPELINE ---------------------
    async function carregarPipeline() {
      try {
        const resp = await fetch(PIPELINE_DATA_URL);
        if (!resp.ok) throw new Error(`Falha ao buscar pipeline: ${resp.status}`);
        const csv = await resp.text();
        const { data, headers } = csvToJson(csv);

        // cria colunas por empresa dentro da div 'tratativas'
        const container = document.getElementById('tratativas');
        // limpa e cria um layout em grid
        const colsHtml = `<div class="pipeline-container" id="pipelineContainer" style="display:flex;gap:16px;overflow:auto;margin-top:16px;"></div>`;
        // remove texto existente e adiciona container
        container.innerHTML = `<h1 class=\"dashboard-title\"><i class=\"fas fa-filter\" style=\"color:#3b82f6\"></i> Pipeline de Tratativas</h1><div id=\"pipelineContainerHolder\"></div>`;
        const pipelineHolder = document.getElementById('pipelineContainerHolder');

        const pipelineContainer = document.createElement('div');
        pipelineContainer.className = 'pipeline-container';
        pipelineContainer.style.display = 'flex';
        pipelineContainer.style.gap = '16px';
        pipelineContainer.style.overflow = 'auto';

        diretorias.forEach(dir => {
          const col = document.createElement('div');
          col.className = 'pipeline-col';
          col.style.flex = '0 0 320px';
          col.style.background = 'white';
          col.style.borderRadius = '12px';
          col.style.boxShadow = '0 4px 6px rgba(0,0,0,0.05)';

          col.innerHTML = `
            <div style="padding:12px;border-bottom:1px solid #eee;background:#f9fafb;border-top-left-radius:12px;border-top-right-radius:12px;">
              <h3 style="margin:0;font-size:1rem;">${dir}</h3>
              <div style="margin-top:8px;font-weight:700;color:#333;">Total: <span class=\"count-value\">0</span></div>
              <div style="margin-top:6px;color:#10b981;font-weight:700;">VGV: <span class=\"vgv-value\">R$ 0</span></div>
            </div>
            <div style="padding:10px;max-height:60vh;overflow:auto;" class="col-content" data-dir="${dir}"></div>
          `;

          pipelineContainer.appendChild(col);
        });

        pipelineHolder.appendChild(pipelineContainer);

        // Preenche itens por empresa
        const vgvSums = { 'YUNY STORE':0, 'PARCERIAS':0, 'YUNY SELL':0 };
        const counts = { 'YUNY STORE':0, 'PARCERIAS':0, 'YUNY SELL':0 };

        // tenta mapear nomes de colunas comuns
        const headerMap = headers.reduce((acc,h)=>{ acc[h.toUpperCase()]=h; return acc; },{});
        const colStatus = headerMap['STATUS'] || headerMap['STAGE'] || headerMap['SITUACAO'] || null;
        const colEmpresa = headerMap['EMPRESA'] || headerMap['COMPANY'] || null;
        const colUnidade = headerMap['UNIDADE'] || headerMap['UNIT'] || headerMap['UNIDADE/NOME'] || null;
        const colVgv = headerMap['VGV'] || headerMap['VALOR'] || null;
        const colTooltip = headerMap['TOOLTIP'] || headerMap['OBS'] || null;

        data.forEach(row => {
          const rawEmpresa = (colEmpresa && row[colEmpresa]) ? row[colEmpresa].toUpperCase() : '';
          const unidade = (colUnidade && row[colUnidade]) ? row[colUnidade] : '';
          const status = (colStatus && row[colStatus]) ? row[colStatus] : '';
          const vgv = (colVgv && row[colVgv]) ? Number(row[colVgv].replace(/[^0-9\-\.]/g,'')) : 0;
          const tooltip = (colTooltip && row[colTooltip]) ? row[colTooltip] : '';

          diretorias.forEach(dir => {
            if (rawEmpresa.includes(dir) || rawEmpresa.includes(dir.replace(' ','').toUpperCase())) {
              counts[dir]++;
              vgvSums[dir] += isNaN(vgv) ? 0 : vgv;

              // encontra a coluna correta para inserir
              const targetCol = Array.from(pipelineContainer.querySelectorAll('.col-content')).find(c => c.dataset.dir === dir);
              if (targetCol) {
                const div = document.createElement('div');
                div.className = 'tratativa-row';
                div.style.marginBottom = '8px';
                div.style.padding = '8px';
                div.style.border = '1px solid #eee';
                div.style.borderRadius = '6px';
                div.innerHTML = `<div style=\"display:flex;justify-content:space-between;align-items:center;gap:8px;\"><div style=\"font-weight:600\">${unidade || '—'}</div><div style=\"font-size:0.9rem;color:#6b7280\">${status || ''}</div></div>`;
                if (tooltip) div.title = tooltip;
                targetCol.appendChild(div);
              }
            }
          });
        });

        // atualiza totais e VGVs
        const cols = pipelineContainer.querySelectorAll('.pipeline-col');
        cols.forEach(col => {
          const dir = col.querySelector('.col-content').dataset.dir;
          const totalElem = col.querySelector('.count-value');
          const vgvElem = col.querySelector('.vgv-value');
          if (totalElem) totalElem.textContent = counts[dir] || 0;
          if (vgvElem) vgvElem.textContent = (vgvSums[dir] && vgvSums[dir] > 0) ? vgvSums[dir].toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}) : 'R$ 0';
        });

      } catch (err) {
        console.error('Erro carregarPipeline:', err);
        const trat = document.getElementById('tratativas');
        trat.insertAdjacentHTML('beforeend', `<div class="error-message">Erro ao carregar pipeline: ${err.message}</div>`);
      }
    }

    // --------------------- Inicialização ---------------------
    carregarResumo();
    carregarPipeline();

  </script>
</body>
</html>
